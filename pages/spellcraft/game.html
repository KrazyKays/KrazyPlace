<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace ‚Äî Spellcraft</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
    main { flex: 1; }
    .hero { padding: 0.5rem; text-align: center; }
    .container-narrow { max-width: 1000px; margin: auto; }
    .daily-box { background: var(--surface-2); border-radius: var(--border-radius); padding: 1.5rem; margin-top: 1rem; }
    .panel { display:flex; gap:1rem; flex-wrap:wrap; justify-content:center; }
    .fragment, .slot { background: var(--surface-3); border-radius: var(--border-radius, 0.25rem); padding:0.6rem; margin:0.3rem; width:220px; border: 1px solid var(--pico-primary); }
    .monster { background: var(--surface-3); border-radius: var(--border-radius, 0.25rem); padding:0.6rem; margin:0.3rem; width:220px; border: 1px solid darkred; }
    .fragment:hover { transform: scale(1.03); cursor:pointer; }
    .slot { min-height:56px; display:flex; align-items:center; justify-content:center; flex-direction:column; }
    .monster.dead { opacity:0.4; filter:grayscale(0.6); }
    .controls { display:flex; gap:0.5rem; justify-content:center; flex-wrap:wrap; }
    .stats { text-align:left; }
    .log { max-height:240px; overflow:auto; white-space:pre-wrap; background:var(--surface-1); padding:0.6rem; border-radius:6px; }
    footer { text-align: center; margin-top: 1rem; border-top: 1px solid var(--surface-3); padding-top: 1rem; }
    .inactive { opacity:0.5; }
  </style>
</head>
<body>

<header class="container container-narrow">
  <nav>
    <ul>
      <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
      <li><a href="#">Spellcraft</a></li>
    </ul>
  </nav>
</header>

<main class="container container-narrow">
<section class="hero">
  <h1>Spellcraft</h1>

  <div style="margin: 1rem 0;" class="controls">
    <button id="dailyGameBtn">Partie du jour üåû</button>
    <button id="randomGameBtn">Partie al√©atoire üé≤</button>
  </div>

  <div class="daily-box" id="gameBox" style="display:none;">
    <h3 id="phaseTitle">Phase de s√©lection ‚Äî Choix 1 / 3</h3>

    <div style="display:flex; gap:1rem; flex-wrap:wrap; justify-content:center;">
      <div style="min-width:260px;">
        <h4>Fragments propos√©s</h4>
        <div id="choices" class="panel"></div>
        <p style="text-align:center; margin-top:0.4rem;">
          <small>Clique sur un fragment pour le s√©lectionner.</small>
        </p>
      </div>

      <div style="min-width:300px;">
        <h4>Fragments poss√©d√©s</h4>
        <div id="spellSlots" class="panel"></div>
        <p style="text-align:center;">
          <small>En combat : maximum 3 fragments peuvent √™tre actifs.</small>
        </p>
      </div>

      <div style="min-width:320px;">
        <h4>Vague actuelle</h4>
        <div id="waveInfo"></div>
        <div id="monsters" class="panel" style="margin-top:0.6rem;"></div>
        <div style="margin-top:0.6rem;">
          <p class="stats"><strong>Statistiques :</strong></p>
          <p id="statSpells">Sorts lanc√©s : 0</p>
          <p id="statDamage">D√©g√¢ts totaux (incl. overkill) : 0</p>
        </div>
      </div>
    </div>

    <div class="controls" style="margin-top:1rem;">
      <button id="castBtn">üî• Lancer le sort</button>
    </div>

    <hr>
    <div style="display:flex; gap:1rem; align-items:flex-start;">
      <div style="flex:1;">
        <h4>Journal</h4>
        <div id="log" class="log"></div>
      </div>

      <div style="width:260px;">
        <h4>R√®gles</h4>
        <ul>
          <li>Tu s√©lectionnes 3 fragments (1 parmi 3, trois fois).</li>
          <li>En combat, tu peux activer/d√©sactiver librement tes fragments.</li>
          <li>Tu peux activer au maximum 3 fragments simultan√©ment.</li>
          <li>Apr√®s chaque vague, tu choisis 1 fragment parmi 3 qui s‚Äôajoute √† ton inventaire.</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="endGame" style="display:none; margin-top:2rem;">
    <h2 id="endTitle">Fin de partie</h2>
    <p id="endSummary"></p>
  </div>
</section>
</main>

<footer><p>¬© KrazyPlace ‚Äî Spellcraft</p></footer>

<script>
/* ---- PRNG ---- */
function pseudoRandom(seed) {
  let s = seed;
  return () => { s = (s * 16807) % 2147483647; return (s - 1) / 2147483646; };
}

/* ---- Fragments ---- */
const FRAGMENTS_POOL = [
  { id:'fire', name:'Flamme', desc:'D√©g√¢ts + br√ªlure', type:'damage', base:60, dot:10 },
  { id:'poison', name:'Poison', desc:'D√©g√¢ts sur la dur√©e', type:'dot', base:10, duration:3 },
  { id:'mark', name:'Marque', desc:'Amplifie le prochain d√©g√¢t', type:'mark', addFlat:30 },
  { id:'crit', name:'Critique', desc:'Chance de critique', type:'crit', critBonus:0.25 },
  { id:'aoe', name:'Onde', desc:'D√©g√¢ts √† tous les ennemis', type:'aoe' },
  { id:'pierce', name:'Perc√©e', desc:'Ignore une partie de la d√©fense', type:'pierce', bonus:20 },
  { id:'shard', name:'√âclat', desc:'Petit d√©g√¢t polyvalent', type:'damage', base:30 },
];

/* ---- Vagues ---- */
const wavesConfig = [
  { n:3, baseHp:80 },
  { n:3, baseHp:120 },
  { n:4, baseHp:160 },
  { n:4, baseHp:230 },
  { n:5, baseHp:330 }
];

/* ---- State ---- */
let rng, seedGlobal;
let choices = [];
let fragments = [];   // inventaire complet
let waveIndex = 0;
let monsters = [];
let spellsCast = 0;
let totalDamage = 0;

let selectionStep = 0; // 0‚Üí1‚Üí2‚Üí3 initiale, puis 999 = combat mode

/* ---- DOM ---- */
const choicesDiv = document.getElementById('choices');
const slotsDiv = document.getElementById('spellSlots');
const waveInfo = document.getElementById('waveInfo');
const monstersDiv = document.getElementById('monsters');
const logDiv = document.getElementById('log');
const statSpells = document.getElementById('statSpells');
const statDamage = document.getElementById('statDamage');
const phaseTitle = document.getElementById('phaseTitle');

/* ---- Buttons ---- */
document.getElementById('dailyGameBtn').onclick = () => {
  const today = new Date().toISOString().split('T')[0];
  const seed = today.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
  startGame(seed);
};
document.getElementById('randomGameBtn').onclick = () => {
  const seed = Math.floor(Math.random() * 2147483647);
  startGame(seed);
};
document.getElementById('castBtn').onclick = () => castSpell();

/* ---- Core ---- */
function startGame(seed) {
  seedGlobal = seed;
  rng = pseudoRandom(seed);

  choices = [];
  fragments = [];
  waveIndex = 0;
  spellsCast = 0;
  totalDamage = 0;
  monsters = [];
  selectionStep = 0;

  document.getElementById('gameBox').style.display = 'block';
  document.getElementById('endGame').style.display = 'none';

  log('Nouvelle partie');

  generateChoices();
  spawnWave();
  updateStats();
  updatePhaseTitle();
}

function updatePhaseTitle() {
  if (selectionStep < 3)
    phaseTitle.textContent = `Phase de s√©lection ‚Äî Choix ${selectionStep + 1} / 3`;
  else
    phaseTitle.textContent = `Combat ‚Äî Active jusqu‚Äô√† 3 fragments`;
}

function log(text) {
  const time = new Date().toLocaleTimeString();
  logDiv.textContent = `[${time}] ${text}\n` + logDiv.textContent;
}

function sampleFromPool() {
  const idx = Math.floor(rng() * FRAGMENTS_POOL.length);
  const base = JSON.parse(JSON.stringify(FRAGMENTS_POOL[idx]));
  base.active = false;
  return base;
}

function generateChoices() {
  choices = [sampleFromPool(), sampleFromPool(), sampleFromPool()];
  renderChoices();
}

function renderChoices() {
  choicesDiv.innerHTML = '';
  choices.forEach((c,i)=>{
    const d = document.createElement('div');
    d.className = 'fragment';
    d.innerHTML = `<strong>${c.name}</strong><br><small>${c.desc}</small>`;
    d.onclick = () => pickFragment(i);
    choicesDiv.appendChild(d);
  });
}

function pickFragment(i) {
  const frag = choices[i];
  fragments.push(frag);
  log(`Tu as obtenu : ${frag.name}`);

  if (selectionStep < 2) {
    selectionStep++;
    generateChoices();
  } else {
    selectionStep = 999; // combat mode
    choices = [];
    choicesDiv.innerHTML = '';
  }

  renderFragments();
  updatePhaseTitle();
}

function renderFragments() {
  slotsDiv.innerHTML = '';
  fragments.forEach((f,i)=>{
    const d = document.createElement('div');
    d.className = 'slot ' + (f.active ? '' : 'inactive');

    d.innerHTML = `
      <strong>${f.name}</strong><br>
      <small>${f.desc}</small><br>
      <button data-i='${i}' class="toggleBtn">${f.active ? 'D√©sactiver' : 'Activer'}</button>
    `;

    d.querySelector('.toggleBtn').onclick = (e)=>{
      e.stopPropagation();
      toggleFragment(i);
    };

    slotsDiv.appendChild(d);
  });
}

function toggleFragment(i) {
  const activeCount = fragments.filter(f=>f.active).length;
  if (!fragments[i].active && activeCount >= 3) {
    alert("Tu ne peux activer que 3 fragments maximum !");
    return;
  }
  fragments[i].active = !fragments[i].active;
  renderFragments();
}

/* ---- Combat ---- */

function spawnWave() {
  if (waveIndex >= wavesConfig.length) return endGame(true);

  const cfg = wavesConfig[waveIndex];
  monsters = [];

  for (let i=0;i<cfg.n;i++){
    const hp = Math.floor(cfg.baseHp + rng() * cfg.baseHp * 0.5);
    monsters.push({ id:i, hp, maxHp:hp, dots:[], marks:0 });
  }

  renderWave();
  log(`Vague ${waveIndex+1} : ${monsters.length} monstres.`);
}

function renderWave() {
  waveInfo.innerHTML = `<strong>Vague ${waveIndex+1} / ${wavesConfig.length}</strong>`;
  monstersDiv.innerHTML = '';

  monsters.forEach((m,i)=>{
    const d = document.createElement('div');
    d.className = 'monster' + (m.hp<=0 ? ' dead' : '');
    d.innerHTML = `<strong>Monstre #${i+1}</strong><br>HP: ${m.hp}/${m.maxHp}`;
    monstersDiv.appendChild(d);
  });
}

function pickTarget() {
  const alive = monsters.filter(m=>m.hp>0);
  if (alive.length===0) return null;
  alive.sort((a,b)=>a.hp-b.hp);
  return alive[0];
}

function applyDOTs() {
  let dotDamage = 0;
  monsters.forEach(m=>{
    if (m.hp<=0) return;
    m.dots = m.dots.filter(d=>{
      m.hp -= d.amount;
      dotDamage += d.amount;
      d.remaining--;
      return d.remaining > 0;
    });
  });

  if (dotDamage>0) {
    totalDamage += dotDamage;
    log(`DOT inflige ${dotDamage} d√©g√¢ts.`);
    updateStats();
    renderWave();
  }
}

function castSpell() {
  if (selectionStep < 3) return alert("Tu dois d'abord terminer la s√©lection des 3 fragments.");
  
  const actives = fragments.filter(f=>f.active);
  if (actives.length === 0) return alert("Active au moins un fragment.");

  spellsCast++;

  let castDamage = 0;
  let isAoE = false;
  let critMult = 1;

  const target = pickTarget();
  if (!target) return log("Aucun ennemi vivant.");

  actives.forEach(f=>{
    if (f.type === 'damage') castDamage += f.base;
    if (f.type === 'dot') target.dots.push({ amount:f.base, remaining:f.duration });
    if (f.type === 'mark') target.marks += f.addFlat;
    if (f.type === 'crit') {
      const chance = f.critBonus + rng()*0.05;
      if (rng() < chance) critMult = 1.75;
    }
    if (f.type === 'aoe') isAoE = true;
    if (f.type === 'pierce') castDamage += f.bonus;
  });

  let damageThisCast = 0;

  if (isAoE) {
    monsters.forEach(m=>{
      if (m.hp<=0) return;
      const dmg = Math.floor((castDamage + m.marks) * critMult) + m.marks;
      m.marks = 0;
      const before = m.hp;
      m.hp -= dmg;
      damageThisCast += before - Math.max(0,m.hp);
    });
    log(`Sort AoE : ${damageThisCast} d√©g√¢ts.`);
  }
  else {
    const dmg = Math.floor((castDamage + target.marks) * critMult) + target.marks;
    target.marks = 0;
    const before = target.hp;
    target.hp -= dmg;
    damageThisCast = before - Math.max(0,target.hp);
    log(`Sort : ${damageThisCast} d√©g√¢ts √† un ennemi.`);
  }

  totalDamage += damageThisCast;
  applyDOTs();
  renderWave();
  updateStats();

  monsters.forEach((m,i)=>{ if (m.hp<=0) log(`Monstre #${i+1} vaincu !`); });

  const alive = monsters.filter(m=>m.hp>0);
  if (alive.length === 0) {
    log(`Vague ${waveIndex+1} √©limin√©e.`);
    waveIndex++;

    if (waveIndex >= wavesConfig.length) return endGame(true);

    selectionStep = 3; // mode "choix 1 fragment"
    phaseTitle.textContent = "Choisis 1 fragment bonus parmi 3";

    generateChoices();
    spawnWave();
  }
}

function updateStats() {
  statSpells.textContent = `Sorts lanc√©s : ${spellsCast}`;
  statDamage.textContent = `D√©g√¢ts totaux : ${totalDamage}`;
}

function endGame(victory) {
  document.getElementById('gameBox').style.display = 'none';
  document.getElementById('endGame').style.display = 'block';

  document.getElementById('endTitle').textContent =
    victory ? 'üèÜ Victoire !' : 'üíÄ D√©faite';

  document.getElementById('endSummary').textContent =
    `Vagues termin√©es : ${Math.min(waveIndex, wavesConfig.length)} / ${wavesConfig.length}.
     Sorts lanc√©s : ${spellsCast}.
     D√©g√¢ts totaux : ${totalDamage}`;

  log("Partie termin√©e.");
}
</script>

</body>
</html>
