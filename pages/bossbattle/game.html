<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace ‚Äî Boss battle</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
    main { flex: 1; }
    .hero { padding: 0.5rem; text-align: center; }
    .container-narrow { max-width: 900px; margin: auto; }
    .daily-box { background: var(--surface-2); border-radius: var(--border-radius); padding: 1.5rem; margin-top: 1rem; }
    .troop, .boss {
      background: var(--surface-3);
      border-radius: var(--border-radius);
      padding: 0.5rem;
      margin: 0.5rem;
      display: inline-block;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      width: 150px;
      position: relative;
    }
    .troop:hover { background: var(--surface-1); transform: scale(1.05); }
    .troop.selected {
      border: 3px solid var(--primary);
      box-shadow: 0 0 10px var(--primary);
      background: rgba(0, 120, 255, 0.15);
      transform: scale(1.1);
    }
    .troop.resting {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.7);
    }
    .resting-label {
      position: absolute;
      bottom: 4px;
      right: 6px;
      background: rgba(255, 200, 0, 0.8);
      color: black;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .rank {
      font-weight: bold;
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      color: white;
      display: inline-block;
    }
    .rank-F { background: #777; }
    .rank-D { background: #8b5cf6; }
    .rank-C { background: #3b82f6; }
    .rank-B { background: #22c55e; }
    .rank-A { background: #f59e0b; }
    .rank-S { background: #ef4444; animation: pulse 1s infinite alternate; }
    @keyframes pulse { from { box-shadow: 0 0 5px #ef4444; } to { box-shadow: 0 0 20px #ef4444; } }
    footer { text-align: center; margin-top: 1rem; border-top: 1px solid var(--surface-3); padding-top: 1rem; }
    /* Ajout visuel pour troupes au repos */
    .resting {
      opacity: 0.5;
      cursor: not-allowed;
      position: relative;
    }
    .resting::after {
      content: "üò¥ Repos";
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255,255,255,0.8);
      color: #000;
      padding: 2px 6px;
      border-radius: 5px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="#">Boss battle</a></li>
      </ul>
    </nav>
  </header>

  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace ‚Äî Boss Battle</h1>
      <p>Forme ton arm√©e et terrasse les 5 boss !</p>

      <div style="margin: 1rem 0;">
        <button id="dailyGameBtn">Partie du jour üåû</button>
        <button id="randomGameBtn">Partie al√©atoire üé≤</button>
      </div>

      <div class="daily-box" id="gameBox" style="display:none;">
        <h3 id="phaseTitle">Recrutement</h3>
        <div id="gameContent"></div>
        <p id="sumDisplay" style="font-weight:bold; margin-top:1rem;"></p>
      </div>

      <div id="endGame" style="display:none; margin-top:2rem;">
        <h2>üéâ Fin de partie</h2>
        <p id="finalMessage"></p>
      </div>
    </section>
  </main>

  <footer><p>¬© KrazyPlace</p></footer>

  <script>
    let rng;
    let army = [];
    let availableChoices = [];
    let currentBossIndex = 0;
    let bosses = [];
    let phase = "recruit";
    let selectedTroops = [];
    
    function startGame(seed) {
      rng = pseudoRandom(seed);
      army = [];
      bosses = generateBosses();
      currentBossIndex = 0;
      phase = "recruit";
      document.getElementById("gameBox").style.display = "block";
      document.getElementById("endGame").style.display = "none";
      nextRecruitmentRound();
    }
    
    function generateTroop() {
      const troop = {
        name: troopNames[Math.floor(rng() * troopNames.length)],
        melee: randomStat(),
        range: randomStat(),
        speed: randomStat(),
        resting: false // nouveau champ
      };
      troop.rank = getRank(troop);
      return troop;
    }
    
    // === Combat ===
    function startBattlePhase() {
      phase = "battle";
      document.getElementById("phaseTitle").textContent = `Combat contre le ${bosses[currentBossIndex].name}`;
      selectedTroops = [];
      renderBattleSetup();
    }
    
    function renderBattleSetup() {
      const container = document.getElementById("gameContent");
      const boss = bosses[currentBossIndex];
      container.innerHTML = `
        <div class="boss"><h3>${boss.name}</h3>
        ‚ù§Ô∏è ${boss.hp} PV<br>
        ‚öîÔ∏è ${boss.melee} | üèπ ${boss.range} | üí® ${boss.speed}</div>
        <p>Choisis les troupes √† envoyer au combat :</p>
        <p id="sumStats">‚öîÔ∏è 0 | üèπ 0 | üí® 0</p>
      `;
    
      let canFight = false;
    
      army.forEach((t, i) => {
        const div = document.createElement("div");
        div.className = "troop";
        if (t.resting) {
          div.classList.add("resting");
        } else {
          canFight = true;
          if (selectedTroops.includes(i)) div.classList.add("selected");
          div.onclick = () => toggleSelection(i, div);
        }
        div.innerHTML = `
          <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
          ‚öîÔ∏è ${t.melee} | üèπ ${t.range} | üí® ${t.speed}
        `;
        container.appendChild(div);
      });
    
      if (!canFight) {
        // toutes les troupes sont au repos ‚Üí d√©faite imm√©diate
        endGame(false, "Toutes tes troupes sont en repos !");
        return;
      }
    
      const launchBtn = document.createElement("button");
      launchBtn.textContent = "‚öîÔ∏è Lancer le combat";
      launchBtn.onclick = launchBattle;
      container.appendChild(launchBtn);
    }
    
    function toggleSelection(index, element) {
      if (army[index].resting) return; // troupes en repos non s√©lectionnables
      if (selectedTroops.includes(index)) {
        selectedTroops = selectedTroops.filter(i => i !== index);
        element.classList.remove("selected");
      } else {
        selectedTroops.push(index);
        element.classList.add("selected");
      }
      updateSumStats();
    }
    
    function updateSumStats() {
      let totalMelee = 0, totalRange = 0, totalSpeed = 0;
      selectedTroops.forEach(i => {
        const t = army[i];
        totalMelee += t.melee;
        totalRange += t.range;
        totalSpeed += t.speed;
      });
      document.getElementById("sumStats").textContent =
        `‚öîÔ∏è ${totalMelee} | üèπ ${totalRange} | üí® ${totalSpeed}`;
    }
    
    function launchBattle() {
      if (selectedTroops.length === 0) return alert("Choisis au moins une troupe !");
      const boss = bosses[currentBossIndex];
    
      // Calcul des stats totales
      let totalMelee = 0, totalRange = 0, totalSpeed = 0;
      selectedTroops.forEach(i => {
        const t = army[i];
        totalMelee += t.melee;
        totalRange += t.range;
        totalSpeed += t.speed;
      });
    
      const diffs = [
        totalMelee - boss.melee,
        totalRange - boss.range,
        totalSpeed - boss.speed
      ];
      const positiveDiffs = diffs.filter(d => d > 0);
      const damage = positiveDiffs.length > 0 ? Math.max(...positiveDiffs) : 0;
    
      boss.hp -= damage;
    
      const container = document.getElementById("gameContent");
      container.innerHTML = `<p>Les troupes infligent ${damage} d√©g√¢ts au ${boss.name} !</p>`;
    
      if (boss.hp <= 0) {
        container.innerHTML += `<p>üí• ${boss.name} est vaincu !</p>`;
        // Les troupes s√©lectionn√©es survivent et se reposent un tour
        selectedTroops.forEach(i => {
          army[i].resting = true;
        });
    
        currentBossIndex++;
        if (currentBossIndex >= bosses.length) {
          endGame(true);
        } else {
          container.innerHTML += `<button onclick="nextTurn()">Tour suivant</button>`;
        }
      } else {
        container.innerHTML += `<p>Il reste ${boss.hp} PV au boss.</p>`;
        // Les troupes meurent si le boss survit
        army = army.filter((_, i) => !selectedTroops.includes(i));
        selectedTroops = [];
        if (army.length === 0) {
          endGame(false);
        } else {
          container.innerHTML += `<button onclick="renderBattleSetup()">Envoyer d'autres troupes</button>`;
        }
      }
    }
    
    function nextTurn() {
      // Les troupes au repos se r√©veillent
      army.forEach(t => {
        if (t.resting) t.resting = false;
      });
      startBattlePhase();
    }
    
    function endGame(victory, msg = "") {
      document.getElementById("gameBox").style.display = "none";
      document.getElementById("endGame").style.display = "block";
      document.getElementById("finalMessage").textContent = victory
        ? "üèÜ Victoire ! Tu as vaincu les 5 boss !"
        : "üíÄ D√©faite... " + (msg || "ton arm√©e a √©t√© an√©antie.");
    }
  </script>
</body>
</html>
