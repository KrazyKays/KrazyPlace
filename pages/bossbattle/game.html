<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace â€” Boss battle</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    main { flex: 1; }
    .hero { padding: 0.5rem; text-align: center; }
    .container-narrow { max-width: 900px; margin: auto; }
    .daily-box {
      background: var(--surface-2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 1rem;
    }
    .troop, .boss {
      background: var(--surface-3);
      border-radius: var(--border-radius, 0.25rem);
      margin: 0.5rem;
      display: inline-block;
      position: relative;
    }
    .troop {
      border: 1px solid var(--pico-primary);
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      width: 220px;
    }
    .boss {
      border: 3px solid darkred;
      padding: 1.5rem;
      width: 300px;
    }
    .troop:hover { background: var(--surface-1); transform: scale(1.05); }
    .troop.selected {
      border: 3px solid var(--primary);
      box-shadow: 0 0 10px var(--primary);
      background: rgba(0, 120, 255, 0.15);
      transform: scale(1.1);
    }
    .troop.resting {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.7);
    }
    .resting-label {
      position: absolute;
      bottom: 4px;
      right: 6px;
      background: rgba(255, 200, 0, 0.8);
      color: black;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .rank {
      font-weight: bold;
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      color: white;
      display: inline-block;
    }
    .rank-F { background: #777; }
    .rank-D { background: #8b5cf6; }
    .rank-C { background: #3b82f6; }
    .rank-B { background: #22c55e; }
    .rank-A { background: #f59e0b; }
    .rank-S {
      background: #ef4444;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      from { box-shadow: 0 0 5px #ef4444; }
      to { box-shadow: 0 0 20px #ef4444; }
    }
    footer {
      text-align: center;
      margin-top: 1rem;
      border-top: 1px solid var(--surface-3);
      padding-top: 1rem;
    }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="#">Boss battle</a></li>
      </ul>
    </nav>
  </header>

  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace â€” Boss Battle</h1>
      <p>Forme ton armÃ©e et terrasse les 5 boss !</p>

      <div class="container-narrow" style="margin-top:2rem; text-align:center;">
        <button id="toggleRulesBtn" data-open="false">ğŸ“˜ Voir les rÃ¨gles</button>
      </div>
      
      <article id="rulesArticle" class="container-narrow" style="display:none; margin-top:1rem;">
        <h2>ğŸ“˜ RÃ¨gles â€” KrazyPlace: Boss Battle</h2>
        <p>ğŸ¯ <strong>But</strong> : recrute 10 troupes et bats les 5 boss sans que ton armÃ©e soit dÃ©truite.</p>

        <h3>ğŸ—ï¸ Recrutement</h3>
        <ul>
          <li>3 troupes alÃ©atoires â†’ choisis-en 1 Ã  chaque tour (jusquâ€™Ã  10).</li>
          <li>Stats : âš”ï¸ MÃªlÃ©e, ğŸ¹ Distance, ğŸƒğŸ» Vitesse.</li>
          <li>Rang global : F Ã  S selon la somme des stats.</li>
        </ul>

        <h3>âš”ï¸ Combats</h3>
        <ul>
          <li>Choisis les troupes Ã  envoyer contre chaque boss.</li>
          <li>Les troupes fatiguÃ©es (repos 1 combat) ne peuvent pas combattre.</li>
          <li>Les dÃ©gÃ¢ts = meilleure diffÃ©rence positive entre tes stats et celles du boss.</li>
        </ul>

        <h3>ğŸ Fin</h3>
        <ul>
          <li>âœ… Victoire : 5 boss vaincus.</li>
          <li>ğŸ’€ DÃ©faite : plus de troupes actives.</li>
        </ul>

        <h3>ğŸ² Modes</h3>
        <ul>
          <li>ğŸŒ Partie du jour â€” mÃªme dÃ©fi pour tous.</li>
          <li>ğŸ² Partie alÃ©atoire â€” nouvelle aventure Ã  chaque fois.</li>
        </ul>

        <blockquote>ğŸ’¡ GÃ¨re bien le repos de tes troupes pour gagner !</blockquote>
      </article>

      <div style="margin: 1rem 0;">
        <button id="dailyGameBtn">Partie du jour ğŸŒ</button>
        <button id="randomGameBtn">Partie alÃ©atoire ğŸ²</button>
      </div>

      <div class="daily-box" id="gameBox" style="display:none;">
        <h3 id="phaseTitle">Recrutement</h3>
        <div id="gameContent"></div>
        <p id="sumDisplay" style="font-weight:bold; margin-top:1rem;"></p>
      </div>

      <div id="endGame" style="display:none; margin-top:2rem;">
        <h2>ğŸ‰ Fin de partie</h2>
        <p id="finalMessage"></p>
      </div>
    </section>
  </main>

  <footer><p>Â© KrazyPlace</p></footer>

  <script>
  const btn = document.getElementById('toggleRulesBtn');
  const article = document.getElementById('rulesArticle');
  const gameBox = document.getElementById('gameBox');
  const endGameDiv = document.getElementById('endGame');
  const phaseTitle = document.getElementById('phaseTitle');
  const gameContent = document.getElementById('gameContent');
  const sumDisplay = document.getElementById('sumDisplay');
  const finalMessage = document.getElementById('finalMessage');

  btn.onclick = () => {
    const open = btn.dataset.open === 'true';
    btn.dataset.open = !open;
    article.style.display = open ? 'none' : 'block';
    btn.textContent = open ? 'ğŸ“˜ Voir les rÃ¨gles' : 'âŒ Masquer les rÃ¨gles';
  };

  const bossesNames = ["Titan de Fer", "Hydre des Sables", "Roi DÃ©mon", "Dragon des Brumes", "Dieu DÃ©chu"];
  let rng, army = [], availableChoices = [], currentBossIndex = 0, bosses = [], phase = "recruit", selectedTroops = [];

  const pseudoRandom = seed => () => (seed = (seed * 16807) % 2147483647, (seed - 1) / 2147483646);
  const randomStat = () => Math.floor(20 + rng() * 80);

  const getRank = t => {
    const total = t.melee + t.range + t.speed;
    return total >= 270 ? "S" : total >= 240 ? "A" : total >= 200 ? "B" :
           total >= 160 ? "C" : total >= 120 ? "D" : "F";
  };

  const generateTroop = () => {
    const types = { melee: ["Guerrier", "Barbare", "Berserker", "Moine"],
                    range: ["Archer", "Mage", "Lancier", "Invocateur"],
                    speed: ["Assassin", "Voleur", "Cavalier", "Ã‰claireur"] };
    const stat = ["melee","range","speed"][Math.floor(rng()*3)];
    const peak = Math.floor(70 + rng() * 40), base1 = randomStat(), base2 = randomStat();
    const pick = () => (rng() < 0.5 ? base1 : base2);
    const troop = {
      name: types[stat][Math.floor(rng() * 4)],
      melee: stat === "melee" ? peak : pick(),
      range: stat === "range" ? peak : pick(),
      speed: stat === "speed" ? peak : pick(),
      resting: 0
    };
    troop.rank = getRank(troop);
    return troop;
  };

  const generateBosses = () =>
    bossesNames.map(name => {
      const weakness = ["melee", "range", "speed"][Math.floor(rng() * 3)];
      const boss = {
        name,
        melee: randomStat() + 50,
        range: randomStat() + 50,
        speed: randomStat() + 50,
        hp: Math.floor(150 + rng() * 300),
        weakness
      };
      boss[weakness] -= Math.floor(15 + rng() * 20);
      return boss;
    });

  function startGame(seed) {
    rng = pseudoRandom(seed);
    army = [];
    bosses = generateBosses();
    currentBossIndex = 0;
    phase = "recruit";
    gameBox.style.display = "block";
    endGameDiv.style.display = "none";
    nextRecruitmentRound();
  }

  function nextRecruitmentRound() {
    if (army.length >= 10) return startBattlePhase();
    phaseTitle.textContent = `Recrutement (${army.length}/10)`;
    availableChoices = Array.from({length:3}, generateTroop);
    renderRecruitChoices();
  }

  function renderRecruitChoices() {
    gameContent.innerHTML = "<p>Choisis une troupe :</p>";
    availableChoices.forEach((t, i) => {
      gameContent.insertAdjacentHTML("beforeend", `
        <div class="troop">
          <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
          âš”ï¸ ${t.melee} | ğŸ¹ ${t.range} | ğŸƒğŸ» ${t.speed}<br>
          <button onclick="selectTroop(${i})">Choisir</button>
        </div>`);
    });
  }

  window.selectTroop = i => { army.push(availableChoices[i]); nextRecruitmentRound(); };

  function startBattlePhase() {
    phase = "battle";
    phaseTitle.textContent = `Combat contre le ${bosses[currentBossIndex].name}`;
    selectedTroops = [];
    renderBattleSetup();
    updateSumDisplay();
  }

  function renderBattleSetup() {
    const boss = bosses[currentBossIndex];
    gameContent.innerHTML = `
      <div class="boss"><h3>${boss.name}</h3>
      â¤ï¸ ${boss.hp} PV<br>âš”ï¸ ${boss.melee} | ğŸ¹ ${boss.range} | ğŸƒğŸ» ${boss.speed}</div>
      <p>Choisis les troupes Ã  envoyer au combat :</p>
      <p id="sumDisplay" style="font-weight:bold; margin-top:0.5rem;">Aucune tro
