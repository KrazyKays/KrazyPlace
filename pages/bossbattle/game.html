<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace — Boss battle</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
    main { flex: 1; }
    .hero { padding: 0.5rem; text-align: center; }
    .container-narrow { max-width: 900px; margin: auto; }
    .daily-box { background: var(--surface-2); border-radius: var(--border-radius); padding: 1.5rem; margin-top: 1rem; }
    .choices button { margin: 0.5rem; }
    .troop, .boss { background: var(--surface-3); border-radius: var(--border-radius); padding: 0.5rem; margin: 0.5rem; display: inline-block; }
    footer { text-align: center; margin-top: 1rem; border-top: 1px solid var(--surface-3); padding-top: 1rem; }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="/krazyplace/pages/bossbattle/game.html">Boss battle</a></li>
      </ul>
    </nav>
  </header>

  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace — Boss Battle</h1>
      <p>Forme ton armée et terrasse les 5 boss !</p>

      <!-- Choix de la partie -->
      <div style="margin: 1rem 0;">
        <button id="dailyGameBtn">Partie du jour 🌞</button>
        <button id="randomGameBtn">Partie aléatoire 🎲</button>
      </div>

      <div class="daily-box" id="gameBox" style="display:none;">
        <h3 id="phaseTitle">Recrutement</h3>
        <div id="gameContent"></div>
      </div>

      <div id="endGame" style="display:none; margin-top:2rem;">
        <h2>🎉 Fin de partie</h2>
        <p id="finalMessage"></p>
      </div>
    </section>
  </main>

  <footer><p>© KrazyPlace</p></footer>

  <script>
  // === Générateur pseudo-aléatoire déterministe ===
  function pseudoRandom(seed) {
    let s = seed;
    return () => {
      s = (s * 16807) % 2147483647;
      return (s - 1) / 2147483646;
    };
  }

  // === Structures de données ===
  const troopNames = ["Guerrier", "Archer", "Lancier", "Mage", "Assassin", "Cavalier", "Golem", "Voleur", "Sorcier", "Barbare", "Moine", "Berserker"];
  const bossesNames = ["Roi Démon", "Hydre des Sables", "Titan de Fer", "Dragon des Brumes", "Dieu Déchu"];

  let rng;
  let army = [];
  let availableChoices = [];
  let currentBossIndex = 0;
  let bosses = [];
  let phase = "recruit"; // recruit → battle → end

  // === Gestion de la partie ===
  function startGame(seed) {
    rng = pseudoRandom(seed);
    army = [];
    bosses = generateBosses();
    currentBossIndex = 0;
    phase = "recruit";
    document.getElementById("gameBox").style.display = "block";
    document.getElementById("endGame").style.display = "none";
    nextRecruitmentRound();
  }

  // === Génération des troupes et boss ===
  function randomStat() {
    return Math.floor(20 + rng() * 80); // 20 à 100
  }

  function generateTroop() {
    return {
      name: troopNames[Math.floor(rng() * troopNames.length)],
      melee: randomStat(),
      range: randomStat(),
      speed: randomStat()
    };
  }

  function generateBosses() {
    return bossesNames.map(name => ({
      name,
      melee: randomStat() + 50,
      range: randomStat() + 50,
      speed: randomStat() + 50,
      hp: Math.floor(300 + rng() * 300)
    }));
  }

  // === Recrutement ===
  function nextRecruitmentRound() {
    if (army.length >= 10) {
      startBattlePhase();
      return;
    }
    phase = "recruit";
    document.getElementById("phaseTitle").textContent = `Recrutement (${army.length}/10)`;
    availableChoices = [generateTroop(), generateTroop(), generateTroop()];
    renderRecruitChoices();
  }

  function renderRecruitChoices() {
    const container = document.getElementById("gameContent");
    container.innerHTML = "<p>Choisis une troupe :</p>";
    availableChoices.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      div.innerHTML = `
        <strong>${t.name}</strong><br>
        ⚔️ ${t.melee} | 🏹 ${t.range} | 💨 ${t.speed}<br>
        <button onclick="selectTroop(${i})">Choisir</button>
      `;
      container.appendChild(div);
    });
  }

  function selectTroop(i) {
    army.push(availableChoices[i]);
    nextRecruitmentRound();
  }

  // === Combat ===
  function startBattlePhase() {
    phase = "battle";
    document.getElementById("phaseTitle").textContent = `Combat contre le ${bosses[currentBossIndex].name}`;
    renderBattleSetup();
  }

  function renderBattleSetup() {
    const container = document.getElementById("gameContent");
    const boss = bosses[currentBossIndex];
    container.innerHTML = `
      <div class="boss"><h3>${boss.name}</h3>
      ❤️ ${boss.hp} PV<br>
      ⚔️ ${boss.melee} | 🏹 ${boss.range} | 💨 ${boss.speed}</div>
      <p>Choisis les troupes à envoyer au combat :</p>
    `;

    army.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      div.innerHTML = `
        <strong>${t.name}</strong><br>
        ⚔️ ${t.melee} | 🏹 ${t.range} | 💨 ${t.speed}<br>
        <button onclick="sendToBattle(${i})">Envoyer</button>
      `;
      container.appendChild(div);
    });
  }

  function sendToBattle(index) {
    const boss = bosses[currentBossIndex];
    const troop = army[index];

    // dégâts = plus grande différence absolue entre une stat du joueur et du boss
    const diffs = [
      Math.abs(troop.melee - boss.melee),
      Math.abs(troop.range - boss.range),
      Math.abs(troop.speed - boss.speed)
    ];
    const damage = Math.max(...diffs);

    boss.hp -= damage;

    // La troupe meurt dans tous les cas
    army.splice(index, 1);

    const container = document.getElementById("gameContent");
    container.innerHTML = `<p>${troop.name} inflige ${damage} dégâts au ${boss.name} !</p>`;

    if (boss.hp <= 0) {
      container.innerHTML += `<p>💥 ${boss.name} est vaincu !</p>`;
      currentBossIndex++;
      if (currentBossIndex >= bosses.length) {
        endGame(true);
      } else {
        container.innerHTML += `<button onclick="startBattlePhase()">Prochain boss</button>`;
      }
    } else if (army.length === 0) {
      endGame(false);
    } else {
      container.innerHTML += `<p>Il reste ${boss.hp} PV au boss.</p><button onclick="renderBattleSetup()">Continuer</button>`;
    }
  }

  // === Fin de partie ===
  function endGame(victory) {
    document.getElementById("gameBox").style.display = "none";
    document.getElementById("endGame").style.display = "block";
    document.getElementById("finalMessage").textContent = victory
      ? "🏆 Victoire ! Tu as vaincu les 5 boss !"
      : "💀 Défaite... ton armée a été anéantie.";
  }

  // === Choix du mode de partie ===
  document.getElementById("dailyGameBtn").onclick = () => {
    const today = new Date().toISOString().split("T")[0];
    const seed = today.split("").reduce((a, c) => a + c.charCodeAt(0), 0);
    startGame(seed);
  };

  document.getElementById("randomGameBtn").onclick = () => {
    const seed = Math.floor(Math.random() * 2147483647);
    startGame(seed);
  };
  </script>
</body>
</html>
