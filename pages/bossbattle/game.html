<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace ‚Äî Boss battle</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
    main { flex: 1; }
    .hero { padding: 0.5rem; text-align: center; }
    .container-narrow { max-width: 900px; margin: auto; }
    .daily-box { background: var(--surface-2); border-radius: var(--border-radius); padding: 1.5rem; margin-top: 1rem; }
    .choices button { margin: 0.5rem; }
    .troop, .boss { background: var(--surface-3); border-radius: var(--border-radius); padding: 0.5rem; margin: 0.5rem; display: inline-block; cursor: pointer; }
    .troop.selected { border: 2px solid var(--primary); background: var(--surface-1); }
    footer { text-align: center; margin-top: 1rem; border-top: 1px solid var(--surface-3); padding-top: 1rem; }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="/krazyplace/pages/bossbattle/game.html">Boss battle</a></li>
      </ul>
    </nav>
  </header>

  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace ‚Äî Boss Battle</h1>
      <p>Forme ton arm√©e et terrasse les 5 boss !</p>

      <!-- Choix de la partie -->
      <div style="margin: 1rem 0;">
        <button id="dailyGameBtn">Partie du jour üåû</button>
        <button id="randomGameBtn">Partie al√©atoire üé≤</button>
      </div>

      <div class="daily-box" id="gameBox" style="display:none;">
        <h3 id="phaseTitle">Recrutement</h3>
        <div id="gameContent"></div>
      </div>

      <div id="endGame" style="display:none; margin-top:2rem;">
        <h2>üéâ Fin de partie</h2>
        <p id="finalMessage"></p>
      </div>
    </section>
  </main>

  <footer><p>¬© KrazyPlace</p></footer>

  <script>
  // === G√©n√©rateur pseudo-al√©atoire d√©terministe ===
  function pseudoRandom(seed) {
    let s = seed;
    return () => {
      s = (s * 16807) % 2147483647;
      return (s - 1) / 2147483646;
    };
  }

  // === Structures de donn√©es ===
  const troopNames = ["Guerrier", "Archer", "Lancier", "Mage", "Assassin", "Cavalier", "Golem", "Voleur", "Sorcier", "Barbare", "Moine", "Berserker"];
  const bossesNames = ["Roi D√©mon", "Hydre des Sables", "Titan de Fer", "Dragon des Brumes", "Dieu D√©chu"];

  let rng;
  let army = [];
  let availableChoices = [];
  let currentBossIndex = 0;
  let bosses = [];
  let phase = "recruit"; // recruit ‚Üí battle ‚Üí end
  let selectedTroops = [];

  // === Gestion de la partie ===
  function startGame(seed) {
    rng = pseudoRandom(seed);
    army = [];
    bosses = generateBosses();
    currentBossIndex = 0;
    phase = "recruit";
    document.getElementById("gameBox").style.display = "block";
    document.getElementById("endGame").style.display = "none";
    nextRecruitmentRound();
  }

  // === G√©n√©ration des troupes et boss ===
  function randomStat() {
    return Math.floor(20 + rng() * 80); // 20 √† 100
  }

  function generateTroop() {
    return {
      name: troopNames[Math.floor(rng() * troopNames.length)],
      melee: randomStat(),
      range: randomStat(),
      speed: randomStat()
    };
  }

  function generateBosses() {
    return bossesNames.map(name => ({
      name,
      melee: randomStat() + 50,
      range: randomStat() + 50,
      speed: randomStat() + 50,
      hp: Math.floor(300 + rng() * 300)
    }));
  }

  // === Recrutement ===
  function nextRecruitmentRound() {
    if (army.length >= 10) {
      startBattlePhase();
      return;
    }
    phase = "recruit";
    document.getElementById("phaseTitle").textContent = `Recrutement (${army.length}/10)`;
    availableChoices = [generateTroop(), generateTroop(), generateTroop()];
    renderRecruitChoices();
  }

  function renderRecruitChoices() {
    const container = document.getElementById("gameContent");
    container.innerHTML = "<p>Choisis une troupe :</p>";
    availableChoices.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      div.innerHTML = `
        <strong>${t.name}</strong><br>
        ‚öîÔ∏è ${t.melee} | üèπ ${t.range} | üí® ${t.speed}<br>
        <button onclick="selectTroop(${i})">Choisir</button>
      `;
      container.appendChild(div);
    });
  }

  function selectTroop(i) {
    army.push(availableChoices[i]);
    nextRecruitmentRound();
  }

  // === Combat ===
  function startBattlePhase() {
    phase = "battle";
    document.getElementById("phaseTitle").textContent = `Combat contre le ${bosses[currentBossIndex].name}`;
    selectedTroops = [];
    renderBattleSetup();
  }

  function renderBattleSetup() {
    const container = document.getElementById("gameContent");
    const boss = bosses[currentBossIndex];
    container.innerHTML = `
      <div class="boss"><h3>${boss.name}</h3>
      ‚ù§Ô∏è ${boss.hp} PV<br>
      ‚öîÔ∏è ${boss.melee} | üèπ ${boss.range} | üí® ${boss.speed}</div>
      <p>Choisis les troupes √† envoyer au combat :</p>
    `;

    army.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      if (selectedTroops.includes(i)) div.classList.add("selected");
      div.onclick = () => toggleSelection(i, div);
      div.innerHTML = `
        <strong>${t.name}</strong><br>
        ‚öîÔ∏è ${t.melee} | üèπ ${t.range} | üí® ${t.speed}
      `;
      container.appendChild(div);
    });

    const launchBtn = document.createElement("button");
    launchBtn.textContent = "‚öîÔ∏è Lancer le combat";
    launchBtn.onclick = launchBattle;
    container.appendChild(launchBtn);
  }

  function toggleSelection(index, element) {
    if (selectedTroops.includes(index)) {
      selectedTroops = selectedTroops.filter(i => i !== index);
      element.classList.remove("selected");
    } else {
      selectedTroops.push(index);
      element.classList.add("selected");
    }
  }

  function launchBattle() {
    if (selectedTroops.length === 0) return alert("Choisis au moins une troupe !");
    const boss = bosses[currentBossIndex];

    // Calcul des d√©g√¢ts totaux inflig√©s par toutes les troupes s√©lectionn√©es
    let totalDamage = 0;
    selectedTroops.forEach(i => {
      const t = army[i];
      const diffs = [
        Math.abs(t.melee - boss.melee),
        Math.abs(t.range - boss.range),
        Math.abs(t.speed - boss.speed)
      ];
      totalDamage += Math.max(...diffs);
    });

    boss.hp -= totalDamage;

    const container = document.getElementById("gameContent");
    container.innerHTML = `<p>Les troupes infligent ${totalDamage} d√©g√¢ts au ${boss.name} !</p>`;

    if (boss.hp <= 0) {
      container.innerHTML += `<p>üí• ${boss.name} est vaincu !</p>`;
      currentBossIndex++;
      if (currentBossIndex >= bosses.length) {
        endGame(true);
      } else {
        container.innerHTML += `<button onclick="startBattlePhase()">Prochain boss</button>`;
      }
    } else {
      container.innerHTML += `<p>Il reste ${boss.hp} PV au boss.</p>`;

      // Les troupes s√©lectionn√©es meurent si le boss survit
      army = army.filter((_, i) => !selectedTroops.includes(i));
      selectedTroops = [];

      if (army.length === 0) {
        endGame(false);
      } else {
        container.innerHTML += `<button onclick="renderBattleSetup()">Envoyer d'autres troupes</button>`;
      }
    }
  }

  // === Fin de partie ===
  function endGame(victory) {
    document.getElementById("gameBox").style.display = "none";
    document.getElementById("endGame").style.display = "block";
    document.getElementById("finalMessage").textContent = victory
      ? "üèÜ Victoire ! Tu as vaincu les 5 boss !"
      : "üíÄ D√©faite... ton arm√©e a √©t√© an√©antie.";
  }

  // === Choix du mode de partie ===
  document.getElementById("dailyGameBtn").onclick = () => {
    const today = new Date().toISOString().split("T")[0];
    const seed = today.split("").reduce((a, c) => a + c.charCodeAt(0), 0);
    startGame(seed);
  };

  document.getElementById("randomGameBtn").onclick = () => {
    const seed = Math.floor(Math.random() * 2147483647);
    startGame(seed);
  };
  </script>
</body>
</html>
