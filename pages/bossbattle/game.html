<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace — Boss battle</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
    main { flex: 1; }
    .hero { padding: 0.5rem; text-align: center; }
    .container-narrow { max-width: 900px; margin: auto; }
    .daily-box { background: var(--surface-2); border-radius: var(--border-radius); padding: 1.5rem; margin-top: 1rem; }

    .troop, .boss {
      background: var(--surface-3);
      border: solid 1px var(--pico-primary);
      border-radius: var(--border-radius, 0.25rem);
      padding: 0.5rem;
      margin: 0.5rem;
      display: inline-block;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      width: 220px;
      position: relative;
    }
    .troop:hover { background: var(--surface-1); transform: scale(1.05); }
    .troop.selected {
      border: 3px solid var(--primary);
      box-shadow: 0 0 10px var(--primary);
      background: rgba(0, 120, 255, 0.15);
      transform: scale(1.1);
    }
    .troop.resting {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.7);
    }
    .resting-label {
      position: absolute;
      bottom: 4px;
      right: 6px;
      background: rgba(255, 200, 0, 0.8);
      color: black;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .rank {
      font-weight: bold;
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      color: white;
      display: inline-block;
    }
    .rank-F { background: #777; }
    .rank-D { background: #8b5cf6; }
    .rank-C { background: #3b82f6; }
    .rank-B { background: #22c55e; }
    .rank-A { background: #f59e0b; }
    .rank-S { background: #ef4444; animation: pulse 1s infinite alternate; }
    @keyframes pulse { from { box-shadow: 0 0 5px #ef4444; } to { box-shadow: 0 0 20px #ef4444; } }
    footer { text-align: center; margin-top: 1rem; border-top: 1px solid var(--surface-3); padding-top: 1rem; }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="#">Boss battle</a></li>
      </ul>
    </nav>
  </header>

  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace — Boss Battle</h1>
      <p>Forme ton armée et terrasse les 5 boss !</p>

      <!-- === BOUTON ET MANUEL DES RÈGLES === -->
      <div class="container container-narrow" style="margin-top: 2rem; text-align:center;">
        <button id="toggleRulesBtn" data-open="false">📘 Voir les règles</button>
      </div>
      
      <article id="rulesArticle" class="container container-narrow" style="display:none; margin-top: 1rem;">
        <h2>📘 Règles du jeu — KrazyPlace: Boss Battle</h2>
      
        <section>
          <h3>🎯 Objectif</h3>
          <p>Forme une armée de <strong>10 troupes</strong> et terrasse les <strong>5 boss</strong> successifs.
          Si ton armée est anéantie avant la fin, la partie est perdue.</p>
        </section>
      
        <section>
          <h3>🏗️ Phase 1 — Recrutement</h3>
          <ul>
            <li>Tu commences la partie sans troupe.</li>
            <li>À chaque tour, <strong>3 troupes aléatoires</strong> te sont proposées.</li>
            <li>Choisis <strong>une troupe</strong> pour rejoindre ton armée.</li>
            <li>Continue jusqu’à avoir <strong>10 troupes</strong> au total.</li>
          </ul>
      
          <p>Chaque troupe possède 3 statistiques :</p>
          <ul>
            <li>⚔️ <strong>Mêlée</strong> — Force au corps-à-corps</li>
            <li>🏹 <strong>Distance</strong> — Puissance à distance</li>
            <li>💨 <strong>Vitesse</strong> — Rapidité d’action</li>
          </ul>
      
          <p>Et un <strong>rang</strong> global selon la somme de ses statistiques :</p>
          <table role="grid">
            <thead>
              <tr><th>Rang</th><th>Niveau global</th></tr>
            </thead>
            <tbody>
              <tr><td>S</td><td>Exceptionnel</td></tr>
              <tr><td>A</td><td>Excellent</td></tr>
              <tr><td>B</td><td>Bon</td></tr>
              <tr><td>C</td><td>Moyen</td></tr>
              <tr><td>D</td><td>Faible</td></tr>
              <tr><td>F</td><td>Médiocre</td></tr>
            </tbody>
          </table>
        </section>
      
        <section>
          <h3>⚔️ Phase 2 — Combats</h3>
          <p>Affronte les boss dans l’ordre suivant :</p>
          <ol>
            <li>Roi Démon</li>
            <li>Hydre des Sables</li>
            <li>Titan de Fer</li>
            <li>Dragon des Brumes</li>
            <li>Dieu Déchu</li>
          </ol>
      
          <p>Avant chaque combat :</p>
          <ul>
            <li>Choisis les troupes à envoyer au combat (une ou plusieurs).</li>
            <li>Les troupes au repos ne peuvent pas participer.</li>
          </ul>
        </section>
      
        <section>
          <h3>💥 Déroulement d’un combat</h3>
          <p>Les statistiques totales de tes troupes sont comparées à celles du boss.</p>
          <ul>
            <li>Pour chaque catégorie (mêlée, distance, vitesse), si ton total dépasse celui du boss, tu infliges des dégâts.</li>
            <li>Les dégâts infligés sont égaux à la <strong>meilleure différence positive</strong> entre tes statistiques et celles du boss.</li>
          </ul>
      
          <details>
            <summary>📊 Exemple de calcul</summary>
            <p>
              Ton armée : ⚔️ 250 | 🏹 300 | 💨 200<br>
              Boss : ⚔️ 260 | 🏹 280 | 💨 220<br>
              👉 Tu infliges <strong>20 dégâts</strong> (meilleure différence = 300 - 280)
            </p>
          </details>
        </section>
      
        <section>
          <h3>😴 Gestion du repos</h3>
          <ul>
            <li>Les troupes ayant combattu se reposent pendant <strong>1 combat</strong> après leur victoire.</li>
            <li>Une troupe en repos ne peut <strong>pas</strong> être sélectionnée.</li>
            <li>Après chaque tour, les troupes au repos redeviennent disponibles.</li>
          </ul>
        </section>
      
        <section>
          <h3>🏁 Fin de partie</h3>
          <ul>
            <li>✅ <strong>Victoire</strong> : tu bats les 5 boss.</li>
            <li>💀 <strong>Défaite</strong> : ton armée est anéantie ou toutes tes troupes sont au repos.</li>
          </ul>
        </section>
      
        <section>
          <h3>🎲 Modes de jeu</h3>
          <ul>
            <li><strong>Partie du jour 🌞</strong> : même défi pour tous les joueurs du jour.</li>
            <li><strong>Partie aléatoire 🎲</strong> : aventure unique à chaque lancement.</li>
          </ul>
        </section>
      
        <blockquote>
          💡 <strong>Astuce</strong> : une bonne gestion de ton équipe et des temps de repos est la clé de la victoire !
        </blockquote>
      </article>

      <div style="margin: 1rem 0;">
        <button id="dailyGameBtn">Partie du jour 🌞</button>
        <button id="randomGameBtn">Partie aléatoire 🎲</button>
      </div>

      <div class="daily-box" id="gameBox" style="display:none;">
        <h3 id="phaseTitle">Recrutement</h3>
        <div id="gameContent"></div>
        <p id="sumDisplay" style="font-weight:bold; margin-top:1rem;"></p>
      </div>

      <div id="endGame" style="display:none; margin-top:2rem;">
        <h2>🎉 Fin de partie</h2>
        <p id="finalMessage"></p>
      </div>
    </section>
  </main>

  <footer><p>© KrazyPlace</p></footer>

  <script>
  const btn = document.getElementById('toggleRulesBtn');
  const article = document.getElementById('rulesArticle');

  btn.addEventListener('click', () => {
    const isOpen = btn.dataset.open === 'true';
    btn.dataset.open = !isOpen;
    article.style.display = isOpen ? 'none' : 'block';
    btn.textContent = isOpen ? '📘 Voir les règles' : '❌ Masquer les règles';
  });

  function pseudoRandom(seed) {
    let s = seed;
    return () => {
      s = (s * 16807) % 2147483647;
      return (s - 1) / 2147483646;
    };
  }

  const troopNames = ["Guerrier", "Archer", "Lancier", "Mage", "Assassin", "Cavalier", "Golem", "Voleur", "Sorcier", "Barbare", "Moine", "Berserker"];
  const bossesNames = ["Roi Démon", "Hydre des Sables", "Titan de Fer", "Dragon des Brumes", "Dieu Déchu"];

  let rng, army = [], availableChoices = [], currentBossIndex = 0, bosses = [];
  let phase = "recruit", selectedTroops = [];

  function startGame(seed) {
    rng = pseudoRandom(seed);
    army = [];
    bosses = generateBosses();
    currentBossIndex = 0;
    phase = "recruit";
    document.getElementById("gameBox").style.display = "block";
    document.getElementById("endGame").style.display = "none";
    nextRecruitmentRound();
  }

  function randomStat() { return Math.floor(20 + rng() * 80); }

  function generateTroop() {
    const troop = {
      name: troopNames[Math.floor(rng() * troopNames.length)],
      melee: randomStat(),
      range: randomStat(),
      speed: randomStat(),
      resting: 0 // 0 = dispo, 1 = repos (inactif pendant 1 combat)
    };
    troop.rank = getRank(troop);
    return troop;
  }

  function getRank(t) {
    const total = t.melee + t.range + t.speed;
    if (total >= 270) return "S";
    if (total >= 240) return "A";
    if (total >= 200) return "B";
    if (total >= 160) return "C";
    if (total >= 120) return "D";
    return "F";
  }

  function generateBosses() {
    return bossesNames.map(name => ({
      name,
      melee: randomStat() + 50,
      range: randomStat() + 50,
      speed: randomStat() + 50,
      hp: Math.floor(300 + rng() * 300)
    }));
  }

  // === Recrutement ===
  function nextRecruitmentRound() {
    if (army.length >= 10) return startBattlePhase();
    phase = "recruit";
    document.getElementById("phaseTitle").textContent = `Recrutement (${army.length}/10)`;
    availableChoices = [generateTroop(), generateTroop(), generateTroop()];
    renderRecruitChoices();
  }

  function renderRecruitChoices() {
    const container = document.getElementById("gameContent");
    container.innerHTML = "<p>Choisis une troupe :</p>";
    availableChoices.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      div.innerHTML = `
        <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
        ⚔️ ${t.melee} | 🏹 ${t.range} | 💨 ${t.speed}<br>
        <button onclick="selectTroop(${i})">Choisir</button>`;
      container.appendChild(div);
    });
  }

  function selectTroop(i) {
    army.push(availableChoices[i]);
    nextRecruitmentRound();
  }

  // === Combat ===
  function startBattlePhase() {
    phase = "battle";
    document.getElementById("phaseTitle").textContent = `Combat contre le ${bosses[currentBossIndex].name}`;
    selectedTroops = [];
    renderBattleSetup();
    updateSumDisplay();
  }

  function renderBattleSetup() {
    const container = document.getElementById("gameContent");
    const boss = bosses[currentBossIndex];
    container.innerHTML = `
      <div class="boss"><h3>${boss.name}</h3>
      ❤️ ${boss.hp} PV<br>
      ⚔️ ${boss.melee} | 🏹 ${boss.range} | 💨 ${boss.speed}</div>
      <p>Choisis les troupes à envoyer au combat :</p>
      <p id="sumDisplay" style="font-weight:bold; margin-top:0.5rem;">Aucune troupe sélectionnée.</p>
    `;

    let canFight = false;
    army.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      if (t.resting > 0) {
        div.classList.add("resting");
        div.innerHTML = `
          <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
          ⚔️ ${t.melee} | 🏹 ${t.range} | 💨 ${t.speed}
          <div class="resting-label">Repos (${t.resting})</div>`;
      } else {
        canFight = true;
        if (selectedTroops.includes(i)) div.classList.add("selected");
        div.onclick = () => toggleSelection(i, div);
        div.innerHTML = `
          <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
          ⚔️ ${t.melee} | 🏹 ${t.range} | 💨 ${t.speed}`;
      }
      container.appendChild(div);
    });

    if (!canFight) {
      endGame(false, "Toutes les troupes sont en repos !");
      return;
    }

    const launchBtn = document.createElement("button");
    launchBtn.textContent = "⚔️ Lancer le combat";
    launchBtn.onclick = launchBattle;
    container.appendChild(launchBtn);
  }

  function toggleSelection(index, element) {
    if (army[index].resting > 0) return;
    if (selectedTroops.includes(index)) {
      selectedTroops = selectedTroops.filter(i => i !== index);
      element.classList.remove("selected");
    } else {
      selectedTroops.push(index);
      element.classList.add("selected");
    }
    updateSumDisplay();
  }

  function updateSumDisplay() {
    const display = document.getElementById("sumDisplay");
    if (!display) return;
    if (selectedTroops.length === 0) {
      display.textContent = "Aucune troupe sélectionnée.";
      return;
    }
    let totalMelee = 0, totalRange = 0, totalSpeed = 0;
    selectedTroops.forEach(i => {
      const t = army[i];
      totalMelee += t.melee;
      totalRange += t.range;
      totalSpeed += t.speed;
    });
    display.textContent = `⚔️ ${totalMelee} | 🏹 ${totalRange} | 💨 ${totalSpeed}`;
  }

  function launchBattle() {
    if (selectedTroops.length === 0) return alert("Choisis au moins une troupe !");
    const boss = bosses[currentBossIndex];

    let totalMelee = 0, totalRange = 0, totalSpeed = 0;
    selectedTroops.forEach(i => {
      const t = army[i];
      totalMelee += t.melee;
      totalRange += t.range;
      totalSpeed += t.speed;
    });

    const diffs = [totalMelee - boss.melee, totalRange - boss.range, totalSpeed - boss.speed];
    const positiveDiffs = diffs.filter(d => d > 0);
    const damage = positiveDiffs.length > 0 ? Math.max(...positiveDiffs) : 0;

    boss.hp -= damage;

    const container = document.getElementById("gameContent");
    // TODO: ajouter emoji du type de degats
    container.innerHTML = `<p>Les troupes infligent ${damage} dégâts au ${boss.name} !</p>`;

    // Les troupes au repos passent à 0 (dispo) si elles ont terminé leur cycle de repos
    army.forEach(t => {
      if (t.resting > 0) t.resting -= 1;
    });

    if (boss.hp <= 0) {
      container.innerHTML += `<p>💥 ${boss.name} est vaincu !</p>`;
      selectedTroops.forEach(i => army[i].resting = 1); // au repos pour 1 combat
      currentBossIndex++;
      if (currentBossIndex >= bosses.length) {
        endGame(true);
      } else {
        container.innerHTML += `<button onclick="startBattlePhase()">Prochain boss</button>`;
      }
    } else {
      container.innerHTML += `<p>Il reste ${boss.hp} PV au boss.</p>`;
      army = army.filter((_, i) => !selectedTroops.includes(i));
      selectedTroops = [];
      if (army.length === 0) {
        endGame(false);
      } else {
        container.innerHTML += `<button onclick="renderBattleSetup()">Envoyer d'autres troupes</button>`;
      }
    }
  }

  function endGame(victory, msg = "") {
    document.getElementById("gameBox").style.display = "none";
    document.getElementById("endGame").style.display = "block";
    document.getElementById("finalMessage").textContent = victory
      ? "🏆 Victoire ! Tu as vaincu les 5 boss !"
      : "💀 Défaite... " + (msg || "ton armée a été anéantie.");
  }

  document.getElementById("dailyGameBtn").onclick = () => {
    const today = new Date().toISOString().split("T")[0];
    const seed = today.split("").reduce((a, c) => a + c.charCodeAt(0), 0);
    startGame(seed);
  };
  document.getElementById("randomGameBtn").onclick = () => {
    const seed = Math.floor(Math.random() * 2147483647);
    startGame(seed);
  };
  </script>
</body>
</html>
