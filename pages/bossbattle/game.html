<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace â€” Boss battle</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body { height: 100%; margin: 0; display: flex; flex-direction: column; }
    main { flex: 1; }
    .hero { padding: 0.5rem; text-align: center; }
    .container-narrow { max-width: 900px; margin: auto; }
    .daily-box { background: var(--surface-2); border-radius: var(--border-radius); padding: 1.5rem; margin-top: 1rem; }

    .troop {
      background: var(--surface-3);
      border: solid 1px var(--pico-primary);
      border-radius: var(--border-radius, 0.25rem);
      padding: 0.5rem;
      margin: 0.5rem;
      display: inline-block;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      width: 220px;
      position: relative;
    }
    .boss {
      background: var(--surface-3);
      border: solid 3px darkred;
      border-radius: var(--border-radius, 0.25rem);
      padding: 1.5rem;
      margin: 0.5rem;
      display: inline-block;
      width: 300px;
      position: relative;
    }
    .troop:hover { background: var(--surface-1); transform: scale(1.05); }
    .troop.selected {
      border: 3px solid var(--primary);
      box-shadow: 0 0 10px var(--primary);
      background: rgba(0, 120, 255, 0.15);
      transform: scale(1.1);
    }
    .troop.resting {
      opacity: 0.5;
      cursor: not-allowed;
      filter: grayscale(0.7);
    }
    .resting-label {
      position: absolute;
      bottom: 4px;
      right: 6px;
      background: rgba(255, 200, 0, 0.8);
      color: black;
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .rank {
      font-weight: bold;
      padding: 0.2rem 0.5rem;
      border-radius: 0.5rem;
      color: white;
      display: inline-block;
    }
    .rank-F { background: #777; }
    .rank-D { background: #8b5cf6; }
    .rank-C { background: #3b82f6; }
    .rank-B { background: #22c55e; }
    .rank-A { background: #f59e0b; }
    .rank-S { background: #ef4444; animation: pulse 1s infinite alternate; }
    @keyframes pulse { from { box-shadow: 0 0 5px #ef4444; } to { box-shadow: 0 0 20px #ef4444; } }
    footer { text-align: center; margin-top: 1rem; border-top: 1px solid var(--surface-3); padding-top: 1rem; }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="#">Boss battle</a></li>
      </ul>
    </nav>
  </header>

  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace â€” Boss Battle</h1>
      <p>Forme ton armÃ©e et terrasse les 5 boss !</p>

      <!-- === BOUTON ET MANUEL DES RÃˆGLES === -->
      <div class="container container-narrow" style="margin-top: 2rem; text-align:center;">
        <button id="toggleRulesBtn" data-open="false">ğŸ“˜ Voir les rÃ¨gles</button>
      </div>
      
      <article id="rulesArticle" class="container container-narrow" style="display:none; margin-top: 1rem;">
        <h2>ğŸ“˜ RÃ¨gles du jeu â€” KrazyPlace: Boss Battle</h2>
      
        <section>
          <h3>ğŸ¯ Objectif</h3>
          <p>Forme une armÃ©e de <strong>10 troupes</strong> et terrasse les <strong>5 boss</strong> successifs.
          Si ton armÃ©e est anÃ©antie avant la fin, la partie est perdue.</p>
        </section>
      
        <section>
          <h3>ğŸ—ï¸ Phase 1 â€” Recrutement</h3>
          <ul>
            <li>Tu commences la partie sans troupe.</li>
            <li>Ã€ chaque tour, <strong>3 troupes alÃ©atoires</strong> te sont proposÃ©es.</li>
            <li>Choisis <strong>une troupe</strong> pour rejoindre ton armÃ©e.</li>
            <li>Continue jusquâ€™Ã  avoir <strong>10 troupes</strong> au total.</li>
          </ul>
      
          <p>Chaque troupe possÃ¨de 3 statistiques :</p>
          <ul>
            <li>âš”ï¸ <strong>MÃªlÃ©e</strong> â€” Force au corps-Ã -corps</li>
            <li>ğŸ¹ <strong>Distance</strong> â€” Puissance Ã  distance</li>
            <li>ğŸƒğŸ» <strong>Vitesse</strong> â€” RapiditÃ© dâ€™action</li>
          </ul>
      
          <p>Et un <strong>rang</strong> global selon la somme de ses statistiques :</p>
          <table role="grid">
            <thead>
              <tr><th>Rang</th><th>Niveau global</th></tr>
            </thead>
            <tbody>
              <tr><td>S</td><td>Exceptionnel</td></tr>
              <tr><td>A</td><td>Excellent</td></tr>
              <tr><td>B</td><td>Bon</td></tr>
              <tr><td>C</td><td>Moyen</td></tr>
              <tr><td>D</td><td>Faible</td></tr>
              <tr><td>F</td><td>MÃ©diocre</td></tr>
            </tbody>
          </table>
        </section>
      
        <section>
          <h3>âš”ï¸ Phase 2 â€” Combats</h3>
          <p>Affronte les 5 boss</p>
      
          <p>Avant chaque combat :</p>
          <ul>
            <li>Choisis les troupes Ã  envoyer au combat (une ou plusieurs).</li>
            <li>Les troupes au repos ne peuvent pas participer.</li>
          </ul>
        </section>
      
        <section>
          <h3>ğŸ’¥ DÃ©roulement dâ€™un combat</h3>
          <p>Les statistiques totales de tes troupes sont comparÃ©es Ã  celles du boss.</p>
          <ul>
            <li>Pour chaque catÃ©gorie (mÃªlÃ©e, distance, vitesse), si ton total dÃ©passe celui du boss, tu infliges des dÃ©gÃ¢ts.</li>
            <li>Les dÃ©gÃ¢ts infligÃ©s sont Ã©gaux Ã  la <strong>meilleure diffÃ©rence positive</strong> entre tes statistiques et celles du boss.</li>
          </ul>
      
          <details>
            <summary>ğŸ“Š Exemple de calcul</summary>
            <p>
              Ton armÃ©e : âš”ï¸ 250 | ğŸ¹ 300 | ğŸƒğŸ» 200<br>
              Boss : âš”ï¸ 260 | ğŸ¹ 280 | ğŸƒğŸ» 220<br>
              ğŸ‘‰ Tu infliges <strong>20 dÃ©gÃ¢ts</strong> (meilleure diffÃ©rence = 300 - 280)
            </p>
          </details>
        </section>
      
        <section>
          <h3>ğŸ˜´ Gestion du repos</h3>
          <ul>
            <li>Les troupes ayant combattu se reposent pendant <strong>1 combat</strong> aprÃ¨s leur victoire.</li>
            <li>Une troupe en repos ne peut <strong>pas</strong> Ãªtre sÃ©lectionnÃ©e.</li>
            <li>AprÃ¨s chaque tour, les troupes au repos redeviennent disponibles.</li>
          </ul>
        </section>
      
        <section>
          <h3>ğŸ Fin de partie</h3>
          <ul>
            <li>âœ… <strong>Victoire</strong> : tu bats les 5 boss.</li>
            <li>ğŸ’€ <strong>DÃ©faite</strong> : ton armÃ©e est anÃ©antie ou toutes tes troupes sont au repos.</li>
          </ul>
        </section>
      
        <section>
          <h3>ğŸ² Modes de jeu</h3>
          <ul>
            <li><strong>Partie du jour ğŸŒ</strong> : mÃªme dÃ©fi pour tous les joueurs du jour.</li>
            <li><strong>Partie alÃ©atoire ğŸ²</strong> : aventure unique Ã  chaque lancement.</li>
          </ul>
        </section>
      
        <blockquote>
          ğŸ’¡ <strong>Astuce</strong> : une bonne gestion de ton Ã©quipe et des temps de repos est la clÃ© de la victoire !
        </blockquote>
      </article>

      <div style="margin: 1rem 0;">
        <button id="dailyGameBtn">Partie du jour ğŸŒ</button>
        <button id="randomGameBtn">Partie alÃ©atoire ğŸ²</button>
      </div>

      <div class="daily-box" id="gameBox" style="display:none;">
        <h3 id="phaseTitle">Recrutement</h3>
        <div id="gameContent"></div>
        <p id="sumDisplay" style="font-weight:bold; margin-top:1rem;"></p>
      </div>

      <div id="endGame" style="display:none; margin-top:2rem;">
        <h2>ğŸ‰ Fin de partie</h2>
        <p id="finalMessage"></p>
      </div>
    </section>
  </main>

  <footer><p>Â© KrazyPlace</p></footer>

  <script>
  const btn = document.getElementById('toggleRulesBtn');
  const article = document.getElementById('rulesArticle');

  btn.addEventListener('click', () => {
    const isOpen = btn.dataset.open === 'true';
    btn.dataset.open = !isOpen;
    article.style.display = isOpen ? 'none' : 'block';
    btn.textContent = isOpen ? 'ğŸ“˜ Voir les rÃ¨gles' : 'âŒ Masquer les rÃ¨gles';
  });

  function pseudoRandom(seed) {
    let s = seed;
    return () => {
      s = (s * 16807) % 2147483647;
      return (s - 1) / 2147483646;
    };
  }

  const bossesNames = ["Titan de Fer", "Hydre des Sables", "Roi DÃ©mon", "Dragon des Brumes", "Dieu DÃ©chu"];

  let rng, army = [], availableChoices = [], currentBossIndex = 0, bosses = [];
  let phase = "recruit", selectedTroops = [];

  function startGame(seed) {
    rng = pseudoRandom(seed);
    army = [];
    bosses = generateBosses();
    currentBossIndex = 0;
    phase = "recruit";
    document.getElementById("gameBox").style.display = "block";
    document.getElementById("endGame").style.display = "none";
    nextRecruitmentRound();
  }

  function randomStat() { return Math.floor(20 + rng() * 80); }

  function generateTroop() {
    // Groupes de noms selon la stat dominante
    const meleeNames = ["Guerrier", "Barbare", "Berserker", "Moine"];
    const rangeNames = ["Archer", "Mage", "Lancier", "Invocateur"];
    const speedNames = ["Assassin", "Voleur", "Cavalier", "Ã‰claireur"];
  
    const stats = ["melee", "range", "speed"];
    const peakStat = stats[Math.floor(rng() * stats.length)];
  
    // Valeurs : un pic et deux stats moyennes
    const peak = Math.floor(70 + rng() * 40); // entre 70 et 110
    const base1 = randomStat();
    const base2 = randomStat();
  
    // GÃ©nÃ©ration des valeurs
    const troop = {
      melee: peakStat === "melee" ? peak : (rng() < 0.5 ? base1 : base2),
      range: peakStat === "range" ? peak : (rng() < 0.5 ? base1 : base2),
      speed: peakStat === "speed" ? peak : (rng() < 0.5 ? base1 : base2),
      resting: 0
    };
  
    // Nom cohÃ©rent selon la stat dominante
    if (peakStat === "melee")
      troop.name = meleeNames[Math.floor(rng() * meleeNames.length)];
    else if (peakStat === "range")
      troop.name = rangeNames[Math.floor(rng() * rangeNames.length)];
    else
      troop.name = speedNames[Math.floor(rng() * speedNames.length)];
  
    troop.rank = getRank(troop);
    return troop;
  }

  function getRank(t) {
    const total = t.melee + t.range + t.speed;
    if (total >= 270) return "S";
    if (total >= 240) return "A";
    if (total >= 200) return "B";
    if (total >= 160) return "C";
    if (total >= 120) return "D";
    return "F";
  }

  function generateBosses() {
    return bossesNames.map(name => {
      const weaknessOptions = ["melee", "range", "speed"];
      const weakness = weaknessOptions[Math.floor(rng() * weaknessOptions.length)];
      const boss = {
        name,
        melee: randomStat() + 50,
        range: randomStat() + 50,
        speed: randomStat() + 50,
        hp: Math.floor(150 + rng() * 300),
        weakness
      };
      // Applique un lÃ©ger malus Ã  la stat faible
      boss[weakness] -= Math.floor(15 + rng() * 20);
      return boss;
    });
  }

  // === Recrutement ===
  function nextRecruitmentRound() {
    if (army.length >= 10) return startBattlePhase();
    phase = "recruit";
    document.getElementById("phaseTitle").textContent = `Recrutement (${army.length}/10)`;
    availableChoices = [generateTroop(), generateTroop(), generateTroop()];
    renderRecruitChoices();
  }

  function renderRecruitChoices() {
    const container = document.getElementById("gameContent");
    container.innerHTML = "<p>Choisis une troupe :</p>";
    availableChoices.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      div.innerHTML = `
        <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
        âš”ï¸ ${t.melee} | ğŸ¹ ${t.range} | ğŸƒğŸ» ${t.speed}<br>
        <button onclick="selectTroop(${i})">Choisir</button>`;
      container.appendChild(div);
    });
  }

  function selectTroop(i) {
    army.push(availableChoices[i]);
    nextRecruitmentRound();
  }

  // === Combat ===
  function startBattlePhase() {
    phase = "battle";
    document.getElementById("phaseTitle").textContent = `Combat contre le ${bosses[currentBossIndex].name}`;
    selectedTroops = [];
    renderBattleSetup();
    updateSumDisplay();
  }

  function renderBattleSetup() {
    const container = document.getElementById("gameContent");
    const boss = bosses[currentBossIndex];
    container.innerHTML = `
      <div class="boss"><h3>${boss.name}</h3>
      â¤ï¸ ${boss.hp} PV<br>
      âš”ï¸ ${boss.melee} | ğŸ¹ ${boss.range} | ğŸƒğŸ» ${boss.speed}</div>
      <p>Choisis les troupes Ã  envoyer au combat :</p>
      <p id="sumDisplay" style="font-weight:bold; margin-top:0.5rem;">Aucune troupe sÃ©lectionnÃ©e.</p>
    `;

    let canFight = false;
    army.forEach((t, i) => {
      const div = document.createElement("div");
      div.className = "troop";
      if (t.resting > 0) {
        div.classList.add("resting");
        div.innerHTML = `
          <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
          âš”ï¸ ${t.melee} | ğŸ¹ ${t.range} | ğŸƒğŸ» ${t.speed}
          <div class="resting-label">Repos (${t.resting})</div>`;
      } else {
        canFight = true;
        if (selectedTroops.includes(i)) div.classList.add("selected");
        div.onclick = () => toggleSelection(i, div);
        div.innerHTML = `
          <strong>${t.name}</strong> <span class="rank rank-${t.rank}">${t.rank}</span><br>
          âš”ï¸ ${t.melee} | ğŸ¹ ${t.range} | ğŸƒğŸ» ${t.speed}`;
      }
      container.appendChild(div);
    });

    if (!canFight) {
      endGame(false, "Toutes les troupes sont en repos !");
      return;
    }

    const launchBtn = document.createElement("button");
    launchBtn.textContent = "âš”ï¸ Lancer le combat";
    launchBtn.onclick = launchBattle;
    container.appendChild(launchBtn);
  }

  function toggleSelection(index, element) {
    if (army[index].resting > 0) return;
    if (selectedTroops.includes(index)) {
      selectedTroops = selectedTroops.filter(i => i !== index);
      element.classList.remove("selected");
    } else {
      selectedTroops.push(index);
      element.classList.add("selected");
    }
    updateSumDisplay();
  }

  function updateSumDisplay() {
    const display = document.getElementById("sumDisplay");
    if (!display) return;
    if (selectedTroops.length === 0) {
      display.textContent = "Aucune troupe sÃ©lectionnÃ©e.";
      return;
    }
    let totalMelee = 0, totalRange = 0, totalSpeed = 0;
    selectedTroops.forEach(i => {
      const t = army[i];
      totalMelee += t.melee;
      totalRange += t.range;
      totalSpeed += t.speed;
    });
    display.textContent = `âš”ï¸ ${totalMelee} | ğŸ¹ ${totalRange} | ğŸƒğŸ» ${totalSpeed}`;
  }

  function launchBattle() {
    if (selectedTroops.length === 0) return alert("Choisis au moins une troupe !");
    const boss = bosses[currentBossIndex];

    let totalMelee = 0, totalRange = 0, totalSpeed = 0;
    selectedTroops.forEach(i => {
      const t = army[i];
      totalMelee += t.melee;
      totalRange += t.range;
      totalSpeed += t.speed;
    });

    const diffs = [totalMelee - boss.melee, totalRange - boss.range, totalSpeed - boss.speed];
    const positiveDiffs = diffs.filter(d => d > 0);
    const damage = positiveDiffs.length > 0 ? Math.max(...positiveDiffs) : 0;

    boss.hp -= damage;

    const container = document.getElementById("gameContent");
    // TODO: ajouter emoji du type de degats
    container.innerHTML = `<p>Les troupes infligent ${damage} dÃ©gÃ¢ts au ${boss.name} !</p>`;

    // Les troupes au repos passent Ã  0 (dispo) si elles ont terminÃ© leur cycle de repos
    army.forEach(t => {
      if (t.resting > 0) t.resting -= 1;
    });

    if (boss.hp <= 0) {
      container.innerHTML += `<p>ğŸ’¥ ${boss.name} est vaincu !</p>`;
      selectedTroops.forEach(i => army[i].resting = 1); // au repos pour 1 combat
      currentBossIndex++;
      if (currentBossIndex >= bosses.length) {
        endGame(true);
      } else {
        setTimeout(() => startBattlePhase(), 1000);
      }
    } else {
      container.innerHTML += `<p>Il reste ${boss.hp} PV au boss.</p>`;
      army = army.filter((_, i) => !selectedTroops.includes(i));
      selectedTroops = [];
      if (army.length === 0) {
        endGame(false);
      } else {
        setTimeout(() => renderBattleSetup(), 1000);
      }
    }
  }

  function endGame(victory, msg = "") {
    document.getElementById("gameBox").style.display = "none";
    document.getElementById("endGame").style.display = "block";
    document.getElementById("finalMessage").textContent = victory
      ? "ğŸ† Victoire ! Tu as vaincu les 5 boss !"
      : "ğŸ’€ DÃ©faite... " + (msg || "ton armÃ©e a Ã©tÃ© anÃ©antie.");
  }

  document.getElementById("dailyGameBtn").onclick = () => {
    const today = new Date().toISOString().split("T")[0];
    const seed = today.split("").reduce((a, c) => a + c.charCodeAt(0), 0);
    startGame(seed);
  };
  document.getElementById("randomGameBtn").onclick = () => {
    const seed = Math.floor(Math.random() * 2147483647);
    startGame(seed);
  };
  </script>
</body>
</html>
