<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace â€” MarchÃ© du jour</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    .hero {
      padding: 4rem 1rem;
      text-align: center;
    }
    .container-narrow {
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .daily-box {
      background: var(--surface-2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 2rem;
    }
    table {
      width: 100%;
      text-align: center;
    }
    td, th {
      padding: 0.5rem;
    }
    .actions button {
      margin: 0.2rem;
    }
    footer {
      margin-top: 3rem;
      text-align: center;
      border-top: 1px solid var(--surface-3);
      padding-top: 1rem;
    }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="/krazyplace/pages/game.html">KGame</a></li>
      </ul>
    </nav>
  </header>
  
  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace â€” KGameðŸ’°</h1>
      <p>Investis sur 10 ans et maximise ton capital !</p>

      <div class="daily-box">
        <h3>AnnÃ©e <span id="year">1</span> / 10</h3>
        <p>Argent : <strong id="money">1000</strong> â‚­</p>
        <p>CoÃ»t de stockage : 2% de la valeur dÃ©tenue Ã  chaque fin dâ€™annÃ©e.</p>

        <table>
          <thead>
            <tr>
              <th>Produit</th>
              <th>Prix actuel</th>
              <th>En stock</th>
              <th class="actions">Actions</th>
            </tr>
          </thead>
          <tbody id="market"></tbody>
        </table>

        <div style="margin-top:1rem;">
          <button id="studyBtn">Faire une Ã©tude de marchÃ© entre N+1 et N+2 (-100 â‚­)</button>
          <button id="nextYearBtn">Passer Ã  l'annÃ©e suivante (et payer le stockage)</button>
        </div>

        <div id="studyResult" style="margin-top:1rem;font-style:italic;"></div>
      </div>

      <div id="endGame" style="display:none;margin-top:2rem;">
        <h2>ðŸŽ‰ Fin de partie</h2>
        <p>Score final : <strong id="finalScore"></strong> â‚­</p>
      </div>
    </section>

    <footer><p>Â© KrazyPlace</p></footer>
  </main>

  <script>
    // === GÃ©nÃ©rateur pseudo-alÃ©atoire dÃ©terministe ===
    function pseudoRandom(seed) {
      let s = seed;
      return () => {
        s = (s * 16807) % 2147483647;
        return (s - 1) / 2147483646;
      };
    }

    // === DonnÃ©es du jour ===
    const today = new Date().toISOString().split("T")[0];

    // MÃªme graine pour tous les joueurs du jour
    const rng = pseudoRandom(
      today.split("").reduce((a, c) => a + c.charCodeAt(0), 0)
    );

    const productsList = [
      "Fer", "Orge", "Huile", "Bois", "Tissu", "Sel", "ThÃ©", "Ã‰pices", "Soie", "Cuivre"
    ];

    // Tire 3 produits fixes pour la journÃ©e
    const products = [];
    while (products.length < 3) {
      const p = productsList[Math.floor(rng() * productsList.length)];
      if (!products.includes(p)) products.push(p);
    }

    // Chaque produit a un prix de base fixe pour la journÃ©e
    const basePrices = products.map(() => Math.floor(50 + rng() * 150));

    // === Ã‰tat du jeu ===
    let year = 1;
    let money = 1000;
    let stock = [0, 0, 0];

    // === Fonction de gÃ©nÃ©ration des prix ===
    function generatePrices(year) {
      return basePrices.map((base, i) => {
        const factor = 1 + Math.sin((year + i) * 1.7 + base) * 0.15 + (rng() - 0.5) * 0.1;
        return Math.max(5, Math.round(base * factor));
      });
    }

    let prices = generatePrices(year);

    // === Affichage du marchÃ© ===
    function renderMarket() {
      const table = document.getElementById("market");
      table.innerHTML = "";
      products.forEach((prod, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${prod}</td>
          <td>${prices[i]} â‚­</td>
          <td>${stock[i]}</td>
          <td class="actions">
            <button onclick="buy(${i})">Acheter</button>
            <button onclick="sell(${i})">Vendre</button>
          </td>`;
        table.appendChild(tr);
      });
      document.getElementById("money").textContent = Math.round(money);
      document.getElementById("year").textContent = year;
    }

    // === Actions joueur ===
    function buy(i) {
      if (money >= prices[i]) {
        money -= prices[i];
        stock[i]++;
        renderMarket();
      }
    }

    function sell(i) {
      if (stock[i] > 0) {
        stock[i]--;
        money += prices[i];
        renderMarket();
      }
    }

    // Ã‰tude de marchÃ©
    document.getElementById("studyBtn").onclick = () => {
      if (money < 100) return;
      money -= 100;
      const next = generatePrices(year + 1);
      const after = generatePrices(year + 2);
      const diffs = next.map((n, i) => ((after[i] - n) / n) * 100);
      const result = diffs
        .map(
          (d, i) =>
            `${products[i]} : ${
              d > 0
                ? "hausse probable de " + d.toFixed(1) + "%"
                : "baisse probable de " + Math.abs(d).toFixed(1) + "%"
            }`
        )
        .join("<br>");
      document.getElementById("studyResult").innerHTML = result;
      renderMarket();
    };

    // Passer Ã  l'annÃ©e suivante
    document.getElementById("nextYearBtn").onclick = () => {
      // frais de stockage
      const stockValue = stock.reduce((sum, q, i) => sum + q * prices[i], 0);
      const storageCost = stockValue * 0.02;
      money -= storageCost;

      year++;
      if (year > 10) {
        endGame();
        return;
      }
      prices = generatePrices(year);
      document.getElementById("studyResult").innerHTML = "";
      renderMarket();
    };

    function endGame() {
      // tout vendre
      const total = stock.reduce((sum, q, i) => sum + q * prices[i], 0);
      money += total;
      document.querySelector(".daily-box").style.display = "none";
      document.getElementById("endGame").style.display = "block";
      document.getElementById("finalScore").textContent = Math.round(money);
    }

    // === Init ===
    renderMarket();
  </script>
</body>
</html>
