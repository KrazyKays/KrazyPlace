<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace â€” MarchÃ© du jour</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }
    
    main {
      flex: 1;
    }
    .hero {
      padding: 0.5rem 0.5rem;
      text-align: center;
    }
    .container-narrow {
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    .daily-box {
      background: var(--surface-2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 1rem;
    }
    #studyBtn {
      margin-bottom: 0.5rem;
    }
    table {
      width: 100%;
      text-align: center;
    }
    td, th {
      padding: 0.5rem;
    }
    .actions button {
      margin: 0.2rem;
    }
    footer {
      margin-top: 1rem;
      text-align: center;
      border-top: 1px solid var(--surface-3);
      padding-top: 1rem;
    }
    #chartContainer {
      margin-top: 2rem;
      background: var(--surface-2);
      border-radius: var(--border-radius);
      padding: 1rem;
    }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="/krazyplace/pages/game.html">KGame</a></li>
      </ul>
    </nav>
  </header>
  
  <main class="container container-narrow">
    <section class="hero">
      <h1>KrazyPlace â€” KGameðŸ’°</h1>
      <p>Investis sur 10 ans et maximise ton capital !</p>

      <!-- Boutons de choix de partie -->
      <div style="margin: 1rem 0;">
        <button id="dailyGameBtn">Partie du jour ðŸŒž</button>
        <button id="randomGameBtn">Partie alÃ©atoire ðŸŽ²</button>
      </div>

      <div class="daily-box" id="gameBox" style="display:none;">
        <h3>AnnÃ©e <span id="year">1</span> / 10</h3>
        <p>Argent : <strong id="money">1000</strong> â‚­</p>
        <p>CoÃ»t de stockage : 2% de la valeur dÃ©tenue Ã  chaque fin dâ€™annÃ©e.</p>

        <table>
          <thead>
            <tr>
              <th>Produit</th>
              <th>Prix actuel</th>
              <th>En stock</th>
              <th class="actions">Actions</th>
            </tr>
          </thead>
          <tbody id="market"></tbody>
        </table>

        <div style="margin-top:1rem;">
          <button id="studyBtn">Faire une Ã©tude de marchÃ© entre N+1 et N+2 (-100 â‚­)</button>
          <div id="studyResult" style="margin:0.5rem 0;font-style:italic;"></div>
          <button id="nextYearBtn">Passer Ã  l'annÃ©e suivante (et payer le stockage)</button>
        </div>

        <!-- Conteneur du graphique -->
        <div id="chartContainer">
          <h4>ðŸ“ˆ Ã‰volution des prix</h4>
          <canvas id="priceChart"></canvas>
        </div>
      </div>

      <div id="endGame" style="display:none;margin-top:2rem;">
        <h2>ðŸŽ‰ Fin de partie</h2>
        <p>Score final : <strong id="finalScore"></strong> â‚­</p>
      </div>
    </section>
  </main>

  <footer><p>Â© KrazyPlace</p></footer>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  // === GÃ©nÃ©rateur pseudo-alÃ©atoire dÃ©terministe ===
  function pseudoRandom(seed) {
    let s = seed;
    return () => {
      s = (s * 16807) % 2147483647;
      return (s - 1) / 2147483646;
    };
  }

  const productsList = [
    "Fer", "Orge", "Huile", "Bois", "Tissu", "Sel", "ThÃ©", "Ã‰pices", "Soie", "Cuivre"
  ];

  let rng, products, basePrices, prices;
  let year, money, stock;
  let priceHistory = [];
  let priceChart;

  function startGame(seed) {
    rng = pseudoRandom(seed);
    products = [];
    while (products.length < 3) {
      const p = productsList[Math.floor(rng() * productsList.length)];
      if (!products.includes(p)) products.push(p);
    }

    basePrices = products.map(() => Math.floor(50 + rng() * 150));
    year = 1;
    money = 1000;
    stock = [0, 0, 0];
    prices = generatePrices(year);
    priceHistory = [prices.slice()];

    document.getElementById("gameBox").style.display = "block";
    document.getElementById("endGame").style.display = "none";
    document.getElementById("studyResult").innerHTML = "";
    renderMarket();
    renderChart();
  }

  function generatePrices(year) {
    return basePrices.map((base, i) => {
      const factor = 1 + Math.sin((year + i) * 1.7 + base) * 0.15 + (rng() - 0.5) * 0.1;
      return Math.max(5, Math.round(base * factor));
    });
  }

  function renderMarket() {
    const table = document.getElementById("market");
    table.innerHTML = "";
    products.forEach((prod, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${prod}</td>
        <td>${prices[i]} â‚­ <small>(${basePrices[i]} â‚­)</small></td>
        <td>${stock[i]}</td>
        <td class="actions">
          <button onclick="buy(${i})">Acheter</button>
          <button onclick="sell(${i})">Vendre</button>
        </td>`;
      table.appendChild(tr);
    });
    document.getElementById("money").textContent = Math.round(money);
    document.getElementById("year").textContent = year;
  }

  // === Actions joueur avec effet sur les prix ===
  function buy(i) {
    if (money >= prices[i]) {
      money -= prices[i];
      stock[i]++;
      // Achat = demande â†‘ â†’ prix augmente lÃ©gÃ¨rement (2 Ã  4 %)
      prices[i] = Math.round(prices[i] * (1.02 + rng() * 0.02));
      renderMarket();
      updateChartAfterTrade();
    }
  }

  function sell(i) {
    if (stock[i] > 0) {
      stock[i]--;
      money += prices[i];
      // Vente = offre â†‘ â†’ prix baisse lÃ©gÃ¨rement (1.5 Ã  3 %)
      prices[i] = Math.round(prices[i] * (0.97 - rng() * 0.015));
      prices[i] = Math.max(5, prices[i]); // pas en dessous de 5 â‚­
      renderMarket();
      updateChartAfterTrade();
    }
  }

  // Ã‰tude de marchÃ©
  document.getElementById("studyBtn").onclick = () => {
    if (money < 100) return;
    money -= 100;
    const next = generatePrices(year + 1);
    const after = generatePrices(year + 2);
    const diffs = next.map((n, i) => ((after[i] - n) / n) * 100);
    const result = diffs
      .map((d, i) => {
        const valeur = Math.round(d);
        return `${products[i]} : ${
          d > 0
            ? "hausse probable de " + valeur + "% entre N+1 et N+2"
            : "baisse probable de " + Math.abs(valeur) + "% entre N+1 et N+2"
        }`;
      })
      .join("<br>");
    document.getElementById("studyResult").innerHTML = result;
    renderMarket();
  };

  // Passer Ã  l'annÃ©e suivante
  document.getElementById("nextYearBtn").onclick = () => {
    const stockValue = stock.reduce((sum, q, i) => sum + q * prices[i], 0);
    const storageCost = stockValue * 0.02;
    money -= storageCost;

    year++;
    if (year > 10) {
      endGame();
      return;
    }

    prices = generatePrices(year);
    priceHistory.push(prices.slice());
    document.getElementById("studyResult").innerHTML = "";
    renderMarket();
    updateChart();
  };

  function endGame() {
    const total = stock.reduce((sum, q, i) => sum + q * prices[i], 0);
    money += total;
    document.getElementById("gameBox").style.display = "none";
    document.getElementById("endGame").style.display = "block";
    document.getElementById("finalScore").textContent = Math.round(money);
  }

  // === Graphique ===
  function renderChart() {
    const ctx = document.getElementById("priceChart").getContext("2d");
    const labels = Array.from({ length: year }, (_, i) => "AnnÃ©e " + (i + 1));
    const datasets = products.map((p, i) => ({
      label: p,
      data: priceHistory.map(row => row[i]),
      borderWidth: 2,
      fill: false,
      tension: 0.2
    }));

    if (priceChart) priceChart.destroy();

    priceChart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: { legend: { position: "bottom" } },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "Prix (â‚­)" } },
          x: { title: { display: true, text: "AnnÃ©es" } }
        }
      }
    });
  }

  function updateChart() {
    const labels = Array.from({ length: year }, (_, i) => "AnnÃ©e " + (i + 1));
    priceChart.data.labels = labels;
    products.forEach((_, i) => {
      priceChart.data.datasets[i].data = priceHistory.map(row => row[i]);
    });
    priceChart.update();
  }

  // Met Ã  jour juste les derniers points quand on trade
  function updateChartAfterTrade() {
    if (!priceChart) return;
    const current = priceHistory[priceHistory.length - 1];
    priceChart.data.datasets.forEach((ds, i) => {
      ds.data[year - 1] = prices[i];
    });
    priceChart.update();
  }

  // === Choix du mode de partie ===
  document.getElementById("dailyGameBtn").onclick = () => {
    const today = new Date().toISOString().split("T")[0];
    const seed = today.split("").reduce((a, c) => a + c.charCodeAt(0), 0);
    startGame(seed);
  };

  document.getElementById("randomGameBtn").onclick = () => {
    const seed = Math.floor(Math.random() * 2147483647);
    startGame(seed);
  };
</script>
</body>
</html>
