<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyPlace ‚Äî KMarket</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <style>
    .hero {
      padding: 3rem 1rem;
      text-align: center;
    }
    .container-narrow {
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }
    footer {
      margin-top: 3rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--surface-3);
      text-align: center;
    }
    .game-box {
      background: var(--surface-2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 2rem;
    }
    .product-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      text-align: left;
    }
    .product {
      padding: 1rem;
      background: var(--surface-1);
      border-radius: var(--border-radius);
    }
    .actions {
      margin-top: 1.5rem;
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <header class="container container-narrow">
    <nav>
      <ul>
        <li class="logo"><a href="/krazyplace">KrazyPlace</a></li>
        <li><a href="#">KMarket</a></li>
      </ul>
    </nav>
  </header>

  <main class="container container-narrow">
    <section class="hero">
      <hgroup>
        <h1>KrazyPlace ‚Äî KMarket</h1>
        <p>Un mini-jeu d‚Äôinvestissement quotidien : achetez, vendez ou anticipez le march√© !</p>
      </hgroup>

      <div class="game-box" id="game">
        <h2>Ann√©e <span id="year">1</span> / 10</h2>
        <p>Fonds : <strong id="funds">1000</strong>‚Çø</p>

        <div class="product-list" id="products"></div>

        <div class="actions">
          <button id="study">Faire une √©tude de march√© (-100‚Çø)</button>
          <button id="next">Passer √† l‚Äôann√©e suivante</button>
        </div>

        <div id="message" style="margin-top:1rem;font-weight:bold;"></div>
      </div>
    </section>

    <footer>
      <p>¬© KrazyPlace ‚Äî KMarket</p>
    </footer>
  </main>

  <!-- Th√®me sombre -->
  <script>
    (function(){
      const key = 'pico-theme-dark';
      if(localStorage.getItem(key) === '1') document.documentElement.style.colorScheme = 'dark';
    })();
  </script>

  <script>
    // --- G√©n√©rateur pseudo-al√©atoire d√©terministe ---
    function pseudoRandomFromString(str) {
      let seed = 0;
      for (let i = 0; i < str.length; i++) {
        seed = (seed * 31 + str.charCodeAt(i)) % 1000000;
      }
      return function() {
        seed = (seed * 1664525 + 1013904223) % 4294967296;
        return seed / 4294967296;
      };
    }

    // --- Donn√©es de base ---
    const today = new Date().toISOString().split('T')[0];
    const rand = pseudoRandomFromString(today);
    const allProducts = ["Or", "P√©trole", "Bl√©", "Technologie", "Crypto", "Immobilier", "Art", "√ânergie solaire", "Acier", "Soie"];

    let products = [];
    let year = 1;
    let funds = 1000;
    let inventory = {};

    // --- Tirage des produits et pr√©-calcul des variations sur 10 ans ---
    function generateDailyProducts() {
      const available = [...allProducts];
      for (let i = 0; i < 3; i++) {
        const idx = Math.floor(rand() * available.length);
        const name = available.splice(idx, 1)[0];
        const basePrice = Math.floor(rand() * 400) + 100;
        let years = [{ year: 1, price: basePrice }];
        let price = basePrice;

        for (let y = 2; y <= 10; y++) {
          const trend = (rand() - 0.5) * 0.4; // ¬±20%
          const noise = (rand() - 0.5) * 0.1; // ¬±5%
          price = Math.max(50, Math.round(price * (1 + trend + noise)));
          years.push({ year: y, price, trend });
        }
        products.push({ name, years });
      }
    }

    // --- Rendu des produits pour l‚Äôann√©e en cours ---
    function renderProducts(showPrediction = false) {
      const list = document.getElementById("products");
      list.innerHTML = "";
      products.forEach(p => {
        const data = p.years.find(y => y.year === year);
        const next = p.years.find(y => y.year === year + 1);
        const owned = inventory[p.name]?.qty || 0;
        const prediction = showPrediction && next
          ? `<br><small>Estimation : ${next.price > data.price ? "+" : ""}${Math.round(((next.price - data.price) / data.price) * 100)}% l‚Äôan prochain</small>`
          : "";
        list.innerHTML += `
          <div class="product">
            <h3>${p.name}</h3>
            <p>Prix actuel : <strong>${data.price}</strong>‚Çø ${prediction}</p>
            <p>Poss√©d√© : ${owned}</p>
            <button onclick="buy('${p.name}')">Acheter</button>
            <button onclick="sell('${p.name}')">Vendre</button>
          </div>
        `;
      });
      document.getElementById("funds").textContent = Math.round(funds);
    }

    function buy(name) {
      const p = products.find(p => p.name === name);
      const price = p.years.find(y => y.year === year).price;
      if (funds < price) return showMessage("Fonds insuffisants !");
      funds -= price;
      if (!inventory[name]) inventory[name] = { qty: 0, buyPrice: 0 };
      const inv = inventory[name];
      inv.buyPrice = (inv.buyPrice * inv.qty + price) / (inv.qty + 1);
      inv.qty++;
      renderProducts();
    }

    function sell(name) {
      const p = products.find(p => p.name === name);
      const price = p.years.find(y => y.year === year).price;
      const inv = inventory[name];
      if (!inv || inv.qty === 0) return showMessage("Aucune unit√© √† vendre !");
      inv.qty--;
      funds += price;
      renderProducts();
    }

    function studyMarket() {
      if (funds < 100) return showMessage("Fonds insuffisants pour l‚Äô√©tude !");
      funds -= 100;
      renderProducts(true);
      showMessage("√âtude de march√© : pr√©visions affich√©es !");
    }

    function nextYear() {
      if (year >= 10) return endGame();
      year++;
      document.getElementById("year").textContent = year;
      renderProducts();
      showMessage("Nouvelle ann√©e, nouveaux prix !");
    }

    function endGame() {
      let total = funds;
      Object.keys(inventory).forEach(name => {
        const inv = inventory[name];
        const p = products.find(p => p.name === name);
        const finalPrice = p.years.find(y => y.year === 10).price;
        total += inv.qty * finalPrice;
      });
      document.getElementById("game").innerHTML = `
        <h2>Fin du jeu üéâ</h2>
        <p>Ann√©e finale : ${year}</p>
        <p>Richesse finale : <strong>${Math.round(total)}‚Çø</strong></p>
        <p>Les produits du jour √©taient : ${products.map(p => p.name).join(", ")}.</p>
        <p>Reviens demain pour un nouveau march√© !</p>
      `;
    }

    function showMessage(msg) {
      const el = document.getElementById("message");
      el.textContent = msg;
      setTimeout(() => (el.textContent = ""), 3000);
    }

    // --- √âv√©nements ---
    document.getElementById("study").onclick = studyMarket;
    document.getElementById("next").onclick = nextYear;

    // --- D√©marrage ---
    generateDailyProducts();
    renderProducts();
  </script>
</body>
</html>
